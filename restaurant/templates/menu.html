{% extends "base.html" %}
{% load static %}

{% block title %}Menu – {{ settings.RESTAURANT_NAME }}{% endblock %}

{% block content %}
<section class="paper-bg">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-10">

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

      <!-- LEFT SIDEBAR (DESKTOP) -->
      <aside class="hidden lg:block lg:col-span-3">
        <div class="lg:sticky lg:top-24">
          <div class="frame p-0 overflow-hidden">

            <!-- Header -->
            <div class="px-6 py-5 border-b border-dark/10 bg-white/25">
              <div class="brand-serif text-2xl font-semibold leading-tight">Menu</div>
            </div>

            <!-- Categories -->
            <div class="px-3 py-3">
              <a href="{% url 'restaurant:menu' %}{% if q %}?q={{ q|urlencode }}{% endif %}"
                 class="group flex items-center gap-3 px-4 py-3 rounded-sm transition
                        {% if not current_category %}bg-[#3e2723] text-beige{% else %}hover:bg-white/60 text-dark{% endif %}">
                <span class="w-6 h-6 flex items-center justify-center {% if not current_category %}text-beige{% else %}text-dark/70{% endif %}">
                  ☰
                </span>
                <span class="text-sm font-semibold tracking-wide">All Categories</span>
              </a>

              <div class="my-3 h-px bg-dark/10"></div>

              <div class="space-y-1">
                {% for cat in categories %}
                  <a href="{% url 'restaurant:menu' %}?category={{ cat.slug }}{% if q %}&q={{ q|urlencode }}{% endif %}"
                     class="group flex items-center gap-3 px-4 py-3 rounded-sm transition
                            {% if current_category and current_category.slug == cat.slug %}bg-[#3e2723] text-beige{% else %}hover:bg-white/60 text-dark{% endif %}">
                    <span class="w-6 h-6 flex items-center justify-center {% if current_category and current_category.slug == cat.slug %}text-beige{% else %}text-dark/70{% endif %}">
                      ❖
                    </span>
                    <span class="text-sm font-semibold tracking-wide">{{ cat.name }}</span>
                  </a>
                {% empty %}
                  <div class="px-4 py-4 text-sm text-dark/60">No categories yet.</div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="lg:col-span-9">

        <!-- MOBILE: Category Toggle + Current Category -->
        <div class="lg:hidden mb-4">
          <div class="frame bg-white/40 px-4 py-3 flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-dark/60">Category</div>
              <div class="brand-serif font-semibold truncate">
                {% if current_category %}{{ current_category.name }}{% else %}All Categories{% endif %}
              </div>
            </div>

            <button type="button"
                    id="mobileCatsBtn"
                    class="btn-wood text-white px-4 py-2 rounded-sm font-semibold text-xs">
              Browse
            </button>
          </div>

          <!-- Mobile categories dropdown -->
          <div id="mobileCatsPanel" class="hidden mt-3 frame bg-white/50 overflow-hidden">
            <div class="px-3 py-3">
              <a href="{% url 'restaurant:menu' %}{% if q %}?q={{ q|urlencode }}{% endif %}"
                 class="block px-4 py-3 rounded-sm transition
                        {% if not current_category %}bg-[#3e2723] text-beige{% else %}hover:bg-white/60 text-dark{% endif %}">
                ☰ <span class="ml-2 text-sm font-semibold">All Categories</span>
              </a>

              <div class="my-3 h-px bg-dark/10"></div>

              <div class="space-y-1">
                {% for cat in categories %}
                  <a href="{% url 'restaurant:menu' %}?category={{ cat.slug }}{% if q %}&q={{ q|urlencode }}{% endif %}"
                     class="block px-4 py-3 rounded-sm transition
                            {% if current_category and current_category.slug == cat.slug %}bg-[#3e2723] text-beige{% else %}hover:bg-white/60 text-dark{% endif %}">
                    ❖ <span class="ml-2 text-sm font-semibold">{{ cat.name }}</span>
                  </a>
                {% endfor %}
              </div>

            </div>
          </div>
        </div>

        <!-- SEARCH + BOOK -->
        <div class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between mb-6">
          <form method="get" class="flex-1" action="{% url 'restaurant:menu' %}">
            <div class="frame flex items-center px-4 py-3">
              <input
                type="text"
                name="q"
                value="{{ q }}"
                placeholder="Search menu..."
                class="w-full bg-transparent outline-none text-sm"
              />
              {% if current_category %}
                <input type="hidden" name="category" value="{{ current_category.slug }}">
              {% endif %}
              <button class="text-gold font-semibold text-sm px-3">Search</button>
            </div>
          </form>

          <a href="{% url 'restaurant:reservation' %}" class="btn-gold px-6 py-3 rounded-sm font-semibold w-fit">
            Book for Dine In →
          </a>
        </div>

        <!-- MOST ORDERED -->
        <div id="most-ordered" class="mb-10">
          <div class="flex items-center justify-between mb-4">
            <h3 class="brand-serif text-3xl font-semibold">Most Ordered</h3>
            <div class="text-sm text-dark/60 hidden sm:block">Chef’s favorites</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for item in most_ordered %}
              <div class="frame p-3 bg-white/35 hover:bg-white/45 transition group">
                <button type="button"
                        class="w-full text-left"
                        data-item-url="{% url 'restaurant:menu_item_detail' item.id %}?ctx=menu">
                  <div class="relative overflow-hidden">
                    {% if item.image %}
                      <img src="{{ item.image.url }}" class="w-full h-44 object-cover transition duration-300 group-hover:scale-[1.02]" alt="{{ item.name }}">
                    {% else %}
                      <div class="w-full h-44 bg-lightbrown/30 flex items-center justify-center text-dark/60">No image</div>
                    {% endif %}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/35 via-transparent to-transparent pointer-events-none"></div>
                  </div>

                  <div class="mt-3">
                    <div class="flex items-start justify-between gap-3">
                      <div class="brand-serif text-lg font-semibold leading-tight group-hover:underline underline-offset-4">
                        {{ item.name }}
                      </div>
                      <div class="brand-serif font-semibold whitespace-nowrap">€ {{ item.price }}</div>
                    </div>

                    {% if item.description %}
                      <div class="text-sm text-dark/70 mt-1">{{ item.description|truncatechars:70 }}</div>
                    {% endif %}
                  </div>
                </button>

                <div class="mt-4 grid grid-cols-2 gap-2">
                  {% if '/delivery/order' not in request.path %}
                    <button type="button"
                            class="btn-wood text-white px-3 py-2 rounded-sm font-semibold text-xs
                                   {% if item.status == 'sold_out' %}opacity-40 cursor-not-allowed{% endif %}"
                            data-add-dinein="{{ item.id }}"
                            data-name="{{ item.name }}"
                            data-price="{{ item.price }}"
                            {% if item.status == "sold_out" %}disabled{% endif %}>
                      Add for Dine In
                    </button>
                  {% endif %}

                  {% if '/book' not in request.path %}
                    <button type="button"
                            class="btn-gold text-dark px-3 py-2 rounded-sm font-semibold text-xs
                                   {% if item.status == 'sold_out' %}opacity-40 cursor-not-allowed{% endif %}"
                            data-add-delivery="{{ item.id }}"
                            {% if item.status == "sold_out" %}disabled{% endif %}>
                      Add for Delivery
                    </button>
                  {% endif %}
                </div>

              </div>
            {% empty %}
              <div class="text-sm text-dark/60">
                No “popular” items yet. Add tag <b>popular</b> from staff panel.
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- MENU ITEMS -->
        <div id="menu-items" class="mb-6">
          <h3 class="brand-serif text-3xl font-semibold mb-4">
            {% if current_category %}{{ current_category.name }}{% else %}All Items{% endif %}
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for item in items %}
              <div class="frame p-4 bg-white/35 hover:bg-white/45 transition">
                <div class="flex gap-4">

                  <button type="button"
                          class="shrink-0"
                          data-item-url="{% url 'restaurant:menu_item_detail' item.id %}?ctx=menu">
                    <div class="w-24 h-24 rounded-sm overflow-hidden border border-dark/10 bg-white/60">
                      {% if item.image %}
                        <img src="{{ item.image.url }}" class="w-full h-full object-cover" alt="{{ item.name }}">
                      {% else %}
                        <div class="w-full h-full bg-lightbrown/30 flex items-center justify-center text-[11px] text-dark/60">
                          No image
                        </div>
                      {% endif %}
                    </div>
                  </button>

                  <div class="min-w-0 flex-1">
                    <button type="button"
                            class="w-full text-left"
                            data-item-url="{% url 'restaurant:menu_item_detail' item.id %}?ctx=menu">
                      <div class="flex items-start justify-between gap-3">
                        <div class="brand-serif text-lg font-semibold leading-tight hover:underline underline-offset-4 truncate">
                          {{ item.name }}
                        </div>
                        <div class="brand-serif font-semibold whitespace-nowrap">€ {{ item.price }}</div>
                      </div>

                      {% if item.description %}
                        <div class="mt-1 text-sm text-dark/70">
                          {{ item.description|truncatechars:90 }}
                        </div>
                      {% endif %}
                    </button>

                    <div class="mt-2 flex items-center gap-2">
                      {% if item.status == 'sold_out' %}
                        <span class="inline-flex text-[11px] font-semibold px-2 py-1 rounded-sm bg-red-500/15 text-red-700 border border-red-500/20">
                          Sold out
                        </span>
                      {% else %}
                        <span class="inline-flex text-[11px] font-semibold px-2 py-1 rounded-sm bg-white/60 border border-dark/10 text-dark/70">
                          Available
                        </span>
                      {% endif %}
                    </div>

                    <div class="mt-3 grid grid-cols-2 gap-2">
                      {% if '/delivery/order' not in request.path %}
                        <button type="button"
                                class="btn-wood text-white px-3 py-2 rounded-sm font-semibold text-xs
                                       {% if item.status == 'sold_out' %}opacity-40 cursor-not-allowed{% endif %}"
                                data-add-dinein="{{ item.id }}"
                                data-name="{{ item.name }}"
                                data-price="{{ item.price }}"
                                {% if item.status == "sold_out" %}disabled{% endif %}>
                          Add for Dine In
                        </button>
                      {% endif %}

                      {% if '/book' not in request.path %}
                        <button type="button"
                                class="btn-gold text-dark px-3 py-2 rounded-sm font-semibold text-xs
                                       {% if item.status == 'sold_out' %}opacity-40 cursor-not-allowed{% endif %}"
                                data-add-delivery="{{ item.id }}"
                                {% if item.status == "sold_out" %}disabled{% endif %}>
                          Add for Delivery
                        </button>
                      {% endif %}
                    </div>

                  </div>
                </div>
              </div>
            {% empty %}
              <div class="text-sm text-dark/60">
                No items found. Add items from staff panel.
              </div>
            {% endfor %}
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Modal (mobile safe) -->
  <div id="itemModal" class="hidden fixed inset-0 z-50">
    <div id="itemModalBackdrop" class="absolute inset-0 bg-black/60"></div>

    <div class="relative max-w-3xl mx-auto bg-beige rounded-sm overflow-hidden shadow-lg
                mt-6 sm:mt-10
                max-h-[85vh] sm:max-h-none
                flex flex-col">
      <div class="flex items-center justify-between px-5 py-4 border-b border-dark/10">
        <div class="font-semibold">Item Details</div>
        <button id="itemModalClose" class="text-dark/70 hover:text-dark text-2xl leading-none">&times;</button>
      </div>
      <div id="itemModalBody" class="overflow-y-auto">
        <div class="p-6 text-sm text-dark/70">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Bottom Cart Bar (mobile checkout preview) -->
  <div id="bottomCartBar" class="hidden fixed bottom-0 left-0 right-0 z-[70] md:hidden">
    <div class="mx-auto max-w-7xl px-4 pb-3">
      <div class="frame bg-white/95 backdrop-blur border border-dark/10 rounded-sm px-4 py-3 flex items-center justify-between gap-3">
        <div class="min-w-0">
          <div id="cartBarTitle" class="text-sm font-semibold text-dark truncate">Cart</div>
          <div id="cartBarMeta" class="text-xs text-dark/70 truncate">0 items</div>
        </div>

        <div class="flex items-center gap-2 shrink-0">
          <button type="button"
                  id="cartBarClose"
                  class="px-3 py-2 rounded-sm border border-dark/15 text-xs font-semibold text-dark/70 hover:text-dark hover:border-dark/30">
            ✕
          </button>

          <a id="cartBarAction"
             href="#"
             class="btn-gold px-4 py-2 rounded-sm text-xs font-semibold text-dark shadow">
            Review
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Spacer so bar doesn't cover last items -->
  <div id="bottomCartSpacer" class="hidden h-24 md:hidden"></div>

  <!-- Toast -->
  <div id="toastAdded"
       class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 z-[60]
              px-4 py-3 rounded-sm shadow-lg border border-dark/10
              bg-white/90 text-dark text-sm font-semibold">
    Added.
  </div>

<script>
(function () {
  // Mobile categories toggle
  const mobileCatsBtn = document.getElementById("mobileCatsBtn");
  const mobileCatsPanel = document.getElementById("mobileCatsPanel");
  if (mobileCatsBtn && mobileCatsPanel) {
    mobileCatsBtn.addEventListener("click", () => {
      mobileCatsPanel.classList.toggle("hidden");
    });
  }

  const modal = document.getElementById("itemModal");
  const body = document.getElementById("itemModalBody");
  const closeBtn = document.getElementById("itemModalClose");
  const backdrop = document.getElementById("itemModalBackdrop");
  const toast = document.getElementById("toastAdded");

  // Bottom bar refs
  const bottomBar = document.getElementById("bottomCartBar");
  const barTitle = document.getElementById("cartBarTitle");
  const barMeta = document.getElementById("cartBarMeta");
  const barAction = document.getElementById("cartBarAction");
  const barClose = document.getElementById("cartBarClose");
  const bottomSpacer = document.getElementById("bottomCartSpacer");

  function showToast(text) {
    if (!toast) return;
    toast.textContent = text || "Added.";
    toast.classList.remove("hidden");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => toast.classList.add("hidden"), 2000);
  }

  function openModal() {
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.add("hidden");
    body.innerHTML = '<div class="p-6 text-sm text-dark/70">Loading...</div>';
    document.body.style.overflow = "";
  }

  if (closeBtn) closeBtn.addEventListener("click", closeModal);
  if (backdrop) backdrop.addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  // ---- Dine-in localStorage cart ----
  const STORAGE_KEY = "reservation_preorder";

  function storePreorderItem(id, name, price, qtyToAdd = 1) {
    id = String(id);
    let cart = {};
    try { cart = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch (e) { cart = {}; }

    if (!cart[id]) cart[id] = { name: name, price: String(price), qty: 0 };
    cart[id].qty = (parseInt(cart[id].qty || 0, 10) || 0) + (parseInt(qtyToAdd, 10) || 1);

    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
  }

  function getDineInSummary() {
    let cart = {};
    try { cart = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch (e) { cart = {}; }

    let totalQty = 0;
    let totalPrice = 0;

    for (const id in cart) {
      const row = cart[id];
      const qty = parseInt(row.qty || 0, 10) || 0;
      const price = parseFloat(row.price || 0) || 0;
      totalQty += qty;
      totalPrice += qty * price;
    }
    return { totalQty, totalPrice };
  }

  function showBottomBar({ mode, qty, totalPrice }) {
    if (!bottomBar || !barTitle || !barMeta || !barAction) return;

    if (mode === "dinein") {
      barTitle.textContent = "Dine-in cart";
      barMeta.textContent = `${qty} item${qty === 1 ? "" : "s"} • € ${Number(totalPrice || 0).toFixed(2)}`;
      barAction.textContent = "Review";
      barAction.href = "{% url 'restaurant:reservation' %}";
    } else {
      barTitle.textContent = "Delivery cart";
      barMeta.textContent = `${qty} item${qty === 1 ? "" : "s"} added`;
      barAction.textContent = "Checkout";
      barAction.href = "{% url 'restaurant:delivery_location' %}";
    }

    bottomBar.classList.remove("hidden");
    if (bottomSpacer) bottomSpacer.classList.remove("hidden");
  }

  function hideBottomBar() {
    if (!bottomBar) return;
    bottomBar.classList.add("hidden");
    if (bottomSpacer) bottomSpacer.classList.add("hidden");
  }

  if (barClose) barClose.addEventListener("click", hideBottomBar);

  // ---- Delivery session cart ----
  function csrfToken() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  async function deliveryAdd(itemId) {
    const fd = new FormData();
    fd.append("item_id", itemId);
    fd.append("qty", 1);

    const res = await fetch("{% url 'restaurant:delivery_cart_add' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken() },
      body: fd
    });

    return res.ok ? res.json() : null;
  }

  async function loadItem(url) {
    openModal();
    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) throw new Error("Failed");
      body.innerHTML = await res.text();
    } catch (err) {
      body.innerHTML = '<div class="p-6 text-sm text-dark/70">Could not load item.</div>';
    }
  }

  document.addEventListener("click", async (e) => {
    // 1) Add for dine-in
    const dineBtn = e.target.closest("[data-add-dinein]");
    if (dineBtn) {
      const id = dineBtn.getAttribute("data-add-dinein");
      const name = dineBtn.getAttribute("data-name") || "Item";
      const price = dineBtn.getAttribute("data-price") || "0";
      storePreorderItem(id, name, price, 1);
      showToast(`Added for dine-in: ${name}`);

      const s = getDineInSummary();
      showBottomBar({ mode: "dinein", qty: s.totalQty, totalPrice: s.totalPrice });
      return;
    }

    // 2) Add for delivery
    const delBtn = e.target.closest("[data-add-delivery]");
    if (delBtn) {
      const id = delBtn.getAttribute("data-add-delivery");
      delBtn.disabled = true;
      delBtn.classList.add("opacity-70");

      const payload = await deliveryAdd(id);

      delBtn.disabled = false;
      delBtn.classList.remove("opacity-70");

      if (payload && payload.ok) {
        showToast("Added for delivery cart");
        // If backend returns qty/total, use it. Otherwise show basic.
        const qty = (payload.qty !== undefined) ? payload.qty : 1;
        showBottomBar({ mode: "delivery", qty: qty, totalPrice: 0 });
      } else {
        showToast("Could not add to delivery cart");
      }
      return;
    }

    // 3) Open modal preview
    const preview = e.target.closest("[data-item-url]");
    if (!preview) return;

    const url = preview.getAttribute("data-item-url");
    if (!url) return;
    loadItem(url);
  });

})();
</script>

</section>
{% endblock %}
