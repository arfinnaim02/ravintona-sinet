{% extends "admin/base.html" %}
{% load static %}

{% block title %}Add Menu Item – {{ settings.RESTAURANT_NAME }}{% endblock %}

{% block content %}
  <!-- Breadcrumb -->
  <div class="text-xs text-dark/70 mb-4">
    Dashboard <span class="mx-1">/</span> Menu <span class="mx-1">/</span>
    <span class="text-dark font-semibold">Add Menu Item</span>
  </div>

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-4xl font-semibold">Add Menu Item</h1>
      <div class="mt-2 text-sm text-dark/60">
        Create a new item for your menu. Preview updates live as you type.
      </div>
    </div>

    <a href="{% url 'restaurant:menu_items_list' %}"
       class="text-sm font-semibold text-dark/70 hover:text-dark underline underline-offset-4">
      ← Back to Items
    </a>
  </div>

  <div class="grid grid-cols-12 gap-8">

    <!-- LEFT: FORM -->
    <form id="menuItemForm"
          method="post"
          enctype="multipart/form-data"
          class="col-span-12 lg:col-span-7 space-y-5">
      {% csrf_token %}

      <!-- Main card -->
      <div class="rounded-2xl border border-dark/10 bg-white/70 p-6">
        <div class="brand-serif text-xl font-semibold text-dark">Item information</div>
        <div class="text-xs uppercase tracking-[0.30em] text-dark/60 mt-1">
          Name, category, price, description
        </div>

        <div class="mt-6 space-y-5">

          <!-- Name -->
          <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
            <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Item name</label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-xs text-red-700 mt-2">{{ form.name.errors }}</div>
            {% endif %}
          </div>

          <!-- Category + Price -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
              <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Category</label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="text-xs text-red-700 mt-2">{{ form.category.errors }}</div>
              {% endif %}
            </div>

            <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
              <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Price (€)</label>
              {{ form.price }}
              <div class="text-[11px] text-dark/55 mt-2">Example: 12.90</div>
              {% if form.price.errors %}
                <div class="text-xs text-red-700 mt-2">{{ form.price.errors }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Description -->
          <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
            <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Description</label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="text-xs text-red-700 mt-2">{{ form.description.errors }}</div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- Media card -->
      <div class="rounded-2xl border border-dark/10 bg-white/70 p-6">
        <div class="brand-serif text-xl font-semibold text-dark">Media</div>
        <div class="text-xs uppercase tracking-[0.30em] text-dark/60 mt-1">
          Image preview (live)
        </div>

        <div class="mt-6 p-4 rounded-xl bg-white/60 border border-dark/15">
          <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Image</label>
          {{ form.image }}
          <div class="text-[11px] text-dark/55 mt-2">(Recommended: 1200×800, max 5MB)</div>
          {% if form.image.errors %}
            <div class="text-xs text-red-700 mt-2">{{ form.image.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Options card -->
      <div class="rounded-2xl border border-dark/10 bg-white/70 p-6">
        <div class="brand-serif text-xl font-semibold text-dark">Options</div>
        <div class="text-xs uppercase tracking-[0.30em] text-dark/60 mt-1">
          Tags, allergens, availability
        </div>

        <div class="mt-6 space-y-5">

          <!-- Tags -->
          <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
            <div class="text-xs uppercase tracking-wider text-dark/60 mb-2">Tags</div>
            <div class="chk bg-white/40 border border-dark/15 rounded-xl p-4">
              {{ form.tags }}
            </div>
            {% if form.tags.errors %}
              <div class="text-xs text-red-700 mt-2">{{ form.tags.errors }}</div>
            {% endif %}
          </div>

          <!-- Allergens -->
          <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
            <div class="text-xs uppercase tracking-wider text-dark/60 mb-2">Allergens</div>
            <div class="chk bg-white/40 border border-dark/15 rounded-xl p-4">
              {{ form.allergens }}
            </div>
            {% if form.allergens.errors %}
              <div class="text-xs text-red-700 mt-2">{{ form.allergens.errors }}</div>
            {% endif %}
          </div>

          <!-- Status -->
          <div class="p-4 rounded-xl bg-white/60 border border-dark/15">
            <label class="block text-xs uppercase tracking-wider text-dark/60 mb-2">Availability</label>
            {{ form.status }}
            {% if form.status.errors %}
              <div class="text-xs text-red-700 mt-2">{{ form.status.errors }}</div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row gap-3">
        <button type="submit"
                class="btn-gold px-7 py-3 rounded-xl font-semibold text-dark w-full sm:w-auto">
          Save Menu Item →
        </button>

        <a href="{% url 'restaurant:dashboard' %}"
           class="px-7 py-3 rounded-xl font-semibold border border-dark/20 hover:bg-white/50 w-full sm:w-auto text-center">
          Cancel
        </a>

        <div class="sm:ml-auto text-[11px] text-dark/55 flex items-center">
          Tip: Add a good photo — it increases orders.
        </div>
      </div>

    </form>

    <!-- RIGHT: LIVE PREVIEW -->
    <aside class="col-span-12 lg:col-span-5">
      <div class="sticky top-24 space-y-4">

        <div class="rounded-2xl border border-dark/10 bg-white/70 p-6">
          <div class="flex items-end justify-between gap-3 mb-4">
            <div>
              <div class="brand-serif text-xl font-semibold text-dark">Live preview</div>
              <div class="text-xs uppercase tracking-[0.30em] text-dark/60 mt-1">
                Updates instantly
              </div>
            </div>

            <span id="previewStatusBadge"
                  class="px-3 py-1 rounded-full text-xs font-semibold border border-dark/10 bg-white/60 text-dark/70">
              Status: —
            </span>
          </div>

          <div class="rounded-2xl overflow-hidden border border-dark/10 bg-white/60">
            <!-- Image preview -->
            <div class="w-full h-52 bg-dark/10 flex items-center justify-center overflow-hidden">
              <img id="previewImage"
                   src=""
                   alt="Preview"
                   class="hidden w-full h-full object-cover">
              <div id="previewImageFallback" class="text-xs text-dark/60">
                Upload an image to preview here.
              </div>
            </div>

            <div class="p-5">
              <div class="text-xs uppercase tracking-wider text-dark/55" id="previewCategory">
                Category: —
              </div>

              <div class="mt-2 text-2xl font-semibold leading-tight text-dark" id="previewName">
                Menu Item Name
              </div>

              <div class="mt-3 flex items-center justify-between">
                <div class="text-lg font-semibold text-dark" id="previewPrice">
                  € 0.00
                </div>
                <div class="text-[11px] text-dark/60" id="previewMeta">
                  Premium listing
                </div>
              </div>

              <div class="mt-3 text-sm text-dark/75 leading-relaxed" id="previewDescription">
                Description will appear here once you add it.
              </div>

              <div class="mt-5">
                <button type="button"
                        class="w-full py-3 rounded-xl font-semibold border border-dark/15 bg-dark/10 text-dark">
                  Add
                </button>
              </div>
            </div>
          </div>

          <div class="mt-4 text-[11px] text-dark/55">
            Note: Live preview is client-side only. Final values are validated on save.
          </div>
        </div>

      </div>
    </aside>

  </div>

  <script>
    (function () {
      // Helper: find field elements even if Django didn't add IDs consistently
      function findInputByName(name) {
        return document.querySelector('[name="' + name + '"]');
      }

      const nameEl = findInputByName("name");
      const priceEl = findInputByName("price");
      const descEl = findInputByName("description");
      const catEl = findInputByName("category");
      const statusEl = findInputByName("status");
      const imageEl = findInputByName("image");

      const previewName = document.getElementById("previewName");
      const previewPrice = document.getElementById("previewPrice");
      const previewDescription = document.getElementById("previewDescription");
      const previewCategory = document.getElementById("previewCategory");
      const previewStatusBadge = document.getElementById("previewStatusBadge");

      const previewImage = document.getElementById("previewImage");
      const previewImageFallback = document.getElementById("previewImageFallback");

      function money(v) {
        const n = parseFloat((v || "").toString().replace(",", "."));
        if (isNaN(n)) return "€ 0.00";
        return "€ " + n.toFixed(2);
      }

      function getSelectedText(selectEl) {
        if (!selectEl) return "—";
        const opt = selectEl.options[selectEl.selectedIndex];
        return opt ? (opt.textContent || "—") : "—";
      }

      function updatePreview() {
        if (previewName && nameEl) {
          previewName.textContent = (nameEl.value || "").trim() || "Menu Item Name";
        }
        if (previewPrice && priceEl) {
          previewPrice.textContent = money(priceEl.value);
        }
        if (previewDescription && descEl) {
          const text = (descEl.value || "").trim();
          previewDescription.textContent = text || "Description will appear here once you add it.";
        }
        if (previewCategory && catEl) {
          previewCategory.textContent = "Category: " + getSelectedText(catEl);
        }
        if (previewStatusBadge && statusEl) {
          previewStatusBadge.textContent = "Status: " + getSelectedText(statusEl);
        }
      }

      function updateImagePreview() {
        if (!imageEl || !imageEl.files || !imageEl.files.length) {
          if (previewImage) previewImage.classList.add("hidden");
          if (previewImageFallback) previewImageFallback.classList.remove("hidden");
          return;
        }
        const file = imageEl.files[0];
        const url = URL.createObjectURL(file);

        if (previewImage) {
          previewImage.src = url;
          previewImage.classList.remove("hidden");
        }
        if (previewImageFallback) previewImageFallback.classList.add("hidden");
      }

      // Attach listeners
      [nameEl, priceEl, descEl, catEl, statusEl].forEach(el => {
        if (!el) return;
        el.addEventListener("input", updatePreview);
        el.addEventListener("change", updatePreview);
      });

      if (imageEl) {
        imageEl.addEventListener("change", updateImagePreview);
      }

      // Initial render
      updatePreview();
      updateImagePreview();
    })();
  </script>
{% endblock %}
