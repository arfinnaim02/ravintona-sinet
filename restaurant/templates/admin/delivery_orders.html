{% extends "admin/base.html" %}
{% load static %}

{% block title %}Delivery Orders – {{ settings.RESTAURANT_NAME }}{% endblock %}

{% block content %}
<section>
  <div class="max-w-6xl mx-auto py-2">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold text-dark tracking-tight">
          Delivery Orders
        </h1>
        <div class="mt-2 text-xs uppercase tracking-[0.35em] text-dark/70">
          Track online orders • Update status • View details
        </div>
      </div>

      <a href="{% url 'restaurant:dashboard' %}"
         class="text-sm font-semibold text-dark/70 hover:text-dark underline underline-offset-4">
        ← Back to Dashboard
      </a>
    </div>

    <!-- Filters -->
    <div class="rounded-2xl border border-dark/10 bg-white/70 p-4 mb-6">
      <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">

        <div class="md:col-span-7">
          <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Search</label>
          <input
            type="text"
            name="q"
            value="{{ q }}"
            placeholder="Search by name, phone, address, order id…"
            class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70"
          />
        </div>

        <div class="md:col-span-3">
          <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Status</label>
          <select
            name="status"
            class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70"
          >
            <option value="">All</option>
            {% for key,label in status_choices %}
              <option value="{{ key }}" {% if status == key %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="md:col-span-2">
          <button class="w-full px-5 py-3 rounded-xl font-semibold text-dark"
                  style="background: linear-gradient(#cdb57b, #a8844a); border: 1px solid rgba(50,30,10,.25); box-shadow: inset 0 1px 0 rgba(255,255,255,.26), 0 10px 22px rgba(0,0,0,.12);">
            Apply →
          </button>
        </div>
      </form>
    </div>

    <!-- Bulk actions -->
<form id="bulkForm" method="post" class="rounded-2xl border border-dark/10 bg-white/70 p-4 mb-6">
  {% csrf_token %}

  <div class="flex flex-col md:flex-row md:items-end gap-3">
    <div class="flex-1">
      <div class="text-xs uppercase tracking-wider text-dark/70 mb-2">Selected orders</div>
      <div id="selectedCount" class="text-sm font-semibold text-dark">0 selected</div>
    </div>

    <div class="md:w-[260px]">
      <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Set status</label>
      <select name="new_status"
              class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70">
        <option value="">Choose status…</option>
        {% for key,label in status_choices %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="flex gap-2">
      <button formaction="{% url 'restaurant:delivery_orders_bulk_update' %}"
              class="px-5 py-3 rounded-xl font-semibold text-dark"
              style="background: linear-gradient(#cdb57b, #a8844a); border: 1px solid rgba(50,30,10,.25); box-shadow: inset 0 1px 0 rgba(255,255,255,.26), 0 10px 22px rgba(0,0,0,.12);">
        Bulk Update →
      </button>

      <button formaction="{% url 'restaurant:delivery_orders_bulk_delete' %}"
              onclick="return confirm('Delete selected orders? This cannot be undone.')"
              class="px-5 py-3 rounded-xl font-semibold text-white"
              style="background: linear-gradient(#6b2d2d, #441b1b); border: 1px solid rgba(255,255,255,.14); box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 10px 22px rgba(0,0,0,.18);">
        Delete
      </button>
    </div>
  </div>
</form>

    <!-- Orders table (NO horizontal scroll) -->
    <div class="rounded-2xl border border-dark/10 bg-white/70 overflow-hidden">
      <table class="w-full text-sm table-fixed">
        <thead class="bg-white/80">
          <tr class="text-left">
            <th class="px-5 py-4 font-semibold text-dark w-[56px]">
              <input id="selectAll" type="checkbox" class="h-4 w-4 accent-[#bfa76f]">
            </th>
            <th class="px-5 py-4 font-semibold text-dark w-[90px]">Order</th>

            <th class="px-5 py-4 font-semibold text-dark w-[38%]">Customer</th>
            <th class="px-5 py-4 font-semibold text-dark w-[150px]">Phone</th>
            <th class="px-5 py-4 font-semibold text-dark w-[110px]">Total</th>
            <th class="px-5 py-4 font-semibold text-dark w-[120px]">Status</th>
            <th class="px-5 py-4 font-semibold text-dark w-[150px]">Created</th>
            <th class="px-5 py-4 font-semibold text-dark text-right w-[110px]">Action</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-dark/10">
          {% for o in orders %}
            <tr class="hover:bg-white/60">
              <td class="px-5 py-4">
                <input type="checkbox"
                      name="order_ids"
                      value="{{ o.id }}"
                      form="bulkForm"
                      class="rowCheck h-4 w-4 accent-[#bfa76f]">
              </td>

              <td class="px-5 py-4 font-semibold text-dark">
                #{{ o.id }}
              </td>


              <td class="px-5 py-4">
                <div class="font-semibold text-dark truncate">
                  {{ o.customer_name }}
                </div>

                <!-- Address stays truncated (no need full) -->
                <div class="text-[11px] text-dark/70 truncate">
                  {{ o.address_label }}{% if o.address_extra %}, {{ o.address_extra }}{% endif %}
                </div>
              </td>

              <td class="px-5 py-4 text-dark/80 truncate">
                {{ o.customer_phone }}
              </td>

              <td class="px-5 py-4 font-semibold text-dark">
                € {{ o.total|floatformat:2 }}
              </td>

              <td class="px-5 py-4">
                <span class="inline-flex px-2.5 py-1 rounded-lg text-[11px] font-semibold border
                  {% if o.status == 'pending' %}
                    bg-gold/20 text-dark border-gold/30
                  {% elif o.status == 'accepted' %}
                    bg-blue-500/10 text-blue-800 border-blue-500/20
                  {% elif o.status == 'cancelled' %}
                    bg-red-500/10 text-red-700 border-red-500/20
                  {% elif o.status == 'delivered' %}
                    bg-green-500/10 text-green-700 border-green-500/20
                  {% else %}
                    bg-white text-dark/70 border-dark/10
                  {% endif %}">
                  {{ o.get_status_display }}
                </span>
              </td>

              <td class="px-5 py-4 text-dark/70">
                {{ o.created_at|date:"d M Y, H:i" }}
              </td>

              <td class="px-5 py-4 text-right">
                <a href="{% url 'restaurant:delivery_order_detail_admin' o.id %}"
                   class="inline-flex items-center justify-center px-4 py-2 rounded-xl font-semibold text-xs text-white"
                   style="background: linear-gradient(#5a3a2f, #3f271f); border: 1px solid rgba(255,255,255,.14); box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 10px 22px rgba(0,0,0,.18);">
                  View →
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="px-6 py-10 text-center text-dark/70">
                No delivery orders found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>
<script>
  const selectAll = document.getElementById("selectAll");
  const checks = () => Array.from(document.querySelectorAll(".rowCheck"));
  const selectedCount = document.getElementById("selectedCount");

  function updateCount(){
    const n = checks().filter(c => c.checked).length;
    selectedCount.textContent = `${n} selected`;
  }

  if (selectAll) {
    selectAll.addEventListener("change", () => {
      checks().forEach(c => c.checked = selectAll.checked);
      updateCount();
    });
  }

  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("rowCheck")) {
      const all = checks();
      const checked = all.filter(c => c.checked).length;
      if (selectAll) selectAll.checked = (checked === all.length && all.length > 0);
      updateCount();
    }
  });

  updateCount();
</script>

{% endblock %}
