{% extends "admin/base.html" %}
{% block title %}Reservations – Admin{% endblock %}

{% block content %}
<section>
  <div class="max-w-6xl mx-auto py-2">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold text-dark tracking-tight">
          Reservations
        </h1>
        <div class="mt-2 text-xs uppercase tracking-[0.35em] text-dark/70">
          Search • Filter • View details
        </div>
      </div>
    </div>

    <!-- Filters (same style as Delivery Orders) -->
    <div class="rounded-2xl border border-dark/10 bg-white/70 p-4 mb-6">
      <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">

        <div class="md:col-span-7">
          <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Search</label>
          <input
            name="q"
            value="{{ q }}"
            placeholder="Search name / phone / email"
            class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70"
          />
        </div>

        <div class="md:col-span-3">
          <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Status</label>
          <select
            name="status"
            class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70"
          >
            <option value="">All statuses</option>
            {% for key,label in status_choices %}
              <option value="{{ key }}" {% if status == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="md:col-span-2">
          <button
            class="w-full px-5 py-3 rounded-xl font-semibold text-dark"
            style="background: linear-gradient(#cdb57b, #a8844a); border: 1px solid rgba(50,30,10,.25); box-shadow: inset 0 1px 0 rgba(255,255,255,.26), 0 10px 22px rgba(0,0,0,.12);"
          >
            Apply →
          </button>
        </div>
      </form>
    </div>

          <!-- Bulk actions -->
      <form id="bulkResForm" method="post" class="rounded-2xl border border-dark/10 bg-white/70 p-4 mb-6">
        {% csrf_token %}

        <div class="flex flex-col md:flex-row md:items-end gap-3">
          <div class="flex-1">
            <div class="text-xs uppercase tracking-wider text-dark/70 mb-2">Selected reservations</div>
            <div id="selectedResCount" class="text-sm font-semibold text-dark">0 selected</div>
          </div>

          <div class="md:w-[260px]">
            <label class="block text-xs uppercase tracking-wider text-dark/70 mb-2">Set status</label>
            <select name="new_status"
                    class="w-full px-4 py-3 rounded-xl border border-dark/15 bg-white outline-none focus:border-gold/70">
              <option value="">Choose status…</option>
              {% for key,label in status_choices %}
                <option value="{{ key }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex gap-2">
            <button formaction="{% url 'restaurant:reservations_bulk_update' %}"
                    class="px-5 py-3 rounded-xl font-semibold text-dark"
                    style="background: linear-gradient(#cdb57b, #a8844a); border: 1px solid rgba(50,30,10,.25); box-shadow: inset 0 1px 0 rgba(255,255,255,.26), 0 10px 22px rgba(0,0,0,.12);">
              Bulk Update →
            </button>

            <button formaction="{% url 'restaurant:reservations_bulk_delete' %}"
                    onclick="return confirm('Delete selected reservations? This cannot be undone.')"
                    class="px-5 py-3 rounded-xl font-semibold text-white"
                    style="background: linear-gradient(#6b2d2d, #441b1b); border: 1px solid rgba(255,255,255,.14); box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 10px 22px rgba(0,0,0,.18);">
              Delete
            </button>
          </div>
        </div>
      </form>

    <!-- Table (no horizontal scroll) -->
    <div class="rounded-2xl border border-dark/10 bg-white/70 overflow-hidden">
      <table class="w-full text-sm table-fixed">
        <thead class="bg-white/80">
         <tr class="text-left">
          <th class="px-5 py-4 font-semibold text-dark w-[56px]">
            <input id="selectAllRes" type="checkbox" class="h-4 w-4 accent-[#bfa76f]">
          </th>
          <th class="px-5 py-4 font-semibold text-dark w-[180px]">When</th>

            <th class="px-5 py-4 font-semibold text-dark w-[42%]">Customer</th>
            <th class="px-5 py-4 font-semibold text-dark w-[140px]">Guests</th>
            <th class="px-5 py-4 font-semibold text-dark w-[140px]">Status</th>
            <th class="px-5 py-4 font-semibold text-dark text-right w-[110px]">Action</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-dark/10">
          {% for r in reservations %}
            <tr class="hover:bg-white/60">
              <td class="px-5 py-4">
                <input type="checkbox"
                      name="reservation_ids"
                      value="{{ r.id }}"
                      form="bulkResForm"
                      class="resRowCheck h-4 w-4 accent-[#bfa76f]">
              </td>

              <td class="px-5 py-4 text-dark/80">
                {{ r.start_datetime|date:"d M Y, H:i" }}
              </td>


              <td class="px-5 py-4">
                <div class="font-semibold text-dark truncate">
                  {{ r.name }}
                </div>
                <div class="text-[11px] text-dark/70 truncate">
                  {{ r.phone }}{% if r.email %} • {{ r.email }}{% endif %}
                </div>
              </td>

              <td class="px-5 py-4 text-dark/80">
                {{ r.party_size }}{% if r.baby_seats %} (+{{ r.baby_seats }} baby){% endif %}
              </td>

              <td class="px-5 py-4">
                <span class="inline-flex px-2.5 py-1 rounded-lg text-[11px] font-semibold border
                  {% if r.status == 'pending' %}
                    bg-gold/20 text-dark border-gold/30
                  {% elif r.status == 'confirmed' %}
                    bg-green-500/10 text-green-700 border-green-500/20
                  {% elif r.status == 'cancelled' %}
                    bg-red-500/10 text-red-700 border-red-500/20
                  {% else %}
                    bg-white text-dark/70 border-dark/10
                  {% endif %}">
                  {{ r.get_status_display }}
                </span>
              </td>

              <td class="px-5 py-4 text-right">
                <a href="{% url 'restaurant:reservation_detail_admin' r.id %}"
                   class="inline-flex items-center justify-center px-4 py-2 rounded-xl font-semibold text-xs text-white"
                   style="background: linear-gradient(#5a3a2f, #3f271f); border: 1px solid rgba(255,255,255,.14); box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 10px 22px rgba(0,0,0,.18);">
                  View →
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-6 py-10 text-center text-dark/70" colspan="6">

                No reservations found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>
<script>
  const selectAllRes = document.getElementById("selectAllRes");
  const resChecks = () => Array.from(document.querySelectorAll(".resRowCheck"));
  const selectedResCount = document.getElementById("selectedResCount");

  function updateResCount(){
    const n = resChecks().filter(c => c.checked).length;
    selectedResCount.textContent = `${n} selected`;
  }

  if (selectAllRes) {
    selectAllRes.addEventListener("change", () => {
      resChecks().forEach(c => c.checked = selectAllRes.checked);
      updateResCount();
    });
  }

  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("resRowCheck")) {
      const all = resChecks();
      const checked = all.filter(c => c.checked).length;
      if (selectAllRes) selectAllRes.checked = (checked === all.length && all.length > 0);
      updateResCount();
    }
  });

  updateResCount();
</script>

{% endblock %}
