{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% blocktrans with restaurant_name=settings.RESTAURANT_NAME %}Reviews – {{ restaurant_name }}{% endblocktrans %}{% endblock %}

{% block content %}
<section class="bg-beige py-20">

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

<!-- ================= TITLE ================= -->
<div class="text-center mb-20">
    <h1 class="brand-script text-5xl md:text-7xl text-dark">
        {% trans "Customer Reviews" %}
    </h1>

    <div class="mt-4 tracking-[0.3em] text-xs text-dark/60 uppercase">
        {% trans "Honest Feedback • Real Experiences • Trusted Quality" %}
    </div>
</div>

<!-- ================= SUMMARY + FORM ================= -->
<div class="grid lg:grid-cols-2 gap-16 items-start mb-24">

<!-- ===== LEFT SIDE ===== -->
<div class="space-y-12">

    <div>
        <div class="text-6xl font-semibold text-dark">
            {{ average_rating|floatformat:1 }}
            <span class="text-2xl text-dark/60">/5</span>
        </div>

        <!-- Dynamic Fractional Stars -->
        <div class="relative w-max mt-6">
            <div class="flex text-5xl text-gray-300">
                ★★★★★
            </div>
            <div class="absolute top-0 left-0 overflow-hidden glossy-stars text-5xl"
                 style="width: {{ star_percentage }}%;">
                ★★★★★
            </div>
        </div>

        <div class="text-dark/70 mt-4 text-sm">
            {% blocktrans count total_reviews=total_reviews %}
                Based on {{ total_reviews }} verified review
            {% plural %}
                Based on {{ total_reviews }} verified reviews
            {% endblocktrans %}
        </div>
    </div>

    <!-- Rating Distribution -->
    <div class="space-y-4">
        {% for item in distribution %}
        <div class="flex items-center gap-4">

            <div class="w-12 text-sm text-dark font-medium">
                {{ item.stars }} ★
            </div>

            <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-3 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full transition-all duration-700"
                     style="width: {{ item.percent }}%;">
                </div>
            </div>

            <div class="w-8 text-sm text-dark/60 text-right">
                {{ item.count }}
            </div>

        </div>
        {% endfor %}
    </div>

</div>


<!-- ===== RIGHT SIDE FORM ===== -->
<div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-10 border border-lightbrown w-full">

    <h2 class="text-2xl font-semibold text-dark mb-8 text-center">
        {% trans "Leave a Review" %}
    </h2>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Name -->
        <div>
            <label class="block text-sm mb-2 text-dark">{% trans "Your Name" %}</label>
            <input type="text" name="name"
                   class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-yellow-500 transition"
                   required>
        </div>

        <!-- Rating -->
        <div>
            <label class="block text-sm mb-3 text-dark">{% trans "Your Rating" %}</label>

            <div id="star-rating"
                 class="flex gap-3 text-3xl sm:text-4xl cursor-pointer select-none justify-center sm:justify-start">
                {% for i in "12345" %}
                    <span class="star text-gray-300 transition"
                          data-value="{{ forloop.counter }}">★</span>
                {% endfor %}
            </div>

            <input type="hidden" name="rating" id="rating-input">
        </div>

        <!-- Review -->
        <div>
            <label class="block text-sm mb-2 text-dark">{% trans "Your Review" %}</label>
            <textarea name="comment" rows="4"
                      class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:border-yellow-500 transition resize-none"
                      required></textarea>
        </div>

        <div class="text-center pt-4">
            <button class="px-10 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-semibold rounded-full shadow-lg hover:scale-105 hover:shadow-xl transition">
                {% trans "Submit Review" %}
            </button>
        </div>

    </form>

</div>
</div>


<!-- ================= REVIEW CARDS ================= -->
<div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-8">

{% for r in reviews %}
<div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition p-6 border border-gray-100">

    <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold text-dark text-sm sm:text-base">
            {{ r.name }}
        </h3>

        <!-- Dynamic Stars Per Review -->
        <div class="relative w-max">
            <div class="flex text-lg text-gray-300">
                ★★★★★
            </div>
                <div class="absolute top-0 left-0 overflow-hidden glossy-stars text-lg"
                    style="width: {{ r.star_width }}%;">

                ★★★★★
            </div>
        </div>
    </div>

    <p class="text-sm text-dark/80 leading-relaxed">
        "{% autoescape on %}{{ r.comment }}{% endautoescape %}"
    </p>

</div>
{% endfor %}

</div>


<!-- Pagination -->
<div class="mt-16 flex justify-center items-center gap-6 text-sm">
    {% if reviews.has_previous %}
        <a href="?page={{ reviews.previous_page_number }}"
           class="px-4 py-2 border rounded hover:bg-gray-100">
           ← {% trans "Previous" %}
        </a>
    {% endif %}

    <span class="text-dark font-medium">
        {% blocktrans with page_num=reviews.number total_pages=reviews.paginator.num_pages %}
            Page {{ page_num }} of {{ total_pages }}
        {% endblocktrans %}
    </span>

    {% if reviews.has_next %}
        <a href="?page={{ reviews.next_page_number }}"
           class="px-4 py-2 border rounded hover:bg-gray-100">
           {% trans "Next" %} →
        </a>
    {% endif %}
</div>

</div>
</section>


<!-- Glossy Star Style -->
<style>
.glossy-stars {
    background: linear-gradient(45deg,#d4af37,#f9e79f,#ffffff,#f9e79f,#b8860b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
</style>


<!-- Star Selector Script -->
<script>
(function(){
  // Django JS gettext (fallback to identity if not loaded)
  const _ = (window.gettext ? window.gettext : (s) => s);

  document.querySelectorAll(".star").forEach(star => {
      star.addEventListener("click", function() {
          let value = this.dataset.value;
          document.getElementById("rating-input").value = value;

          document.querySelectorAll(".star").forEach((s, index) => {
              if (index < value) {
                  s.classList.add("glossy-stars");
                  s.classList.remove("text-gray-300");
              } else {
                  s.classList.remove("glossy-stars");
                  s.classList.add("text-gray-300");
              }
          });
      });
  });
})();
</script>

{% endblock %}