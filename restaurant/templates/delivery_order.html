{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Order Online" %} – {{ settings.RESTAURANT_NAME }}{% endblock %}

{% block content %}
<section class="paper-bg">
  <div class="max-w-7xl mx-auto px-6 py-10">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
      <div>
        <div class="brand-script text-5xl text-dark">{% trans "Order Online" %}</div>

        <div class="mt-2 text-xs uppercase tracking-[0.35em] text-dark/60">
          {% trans "Delivery distance:" %}
          <b id="distanceTop">{{ delivery_distance_km|floatformat:2 }} km</b>
          • {% trans "Delivery fee:" %}
          <b id="feeTop">€ {{ delivery_fee|floatformat:2 }}</b>
        </div>

        {% if promo.active %}
          <div class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-sm bg-gold/15 border border-gold/20 text-sm text-dark">
            <span class="font-semibold">{% trans "Offer:" %}</span>
            <span>{{ promo.title }}</span>
            {% if promo.free_delivery %}
              <span class="ml-2 px-2 py-1 rounded-sm bg-dark text-beige text-xs font-semibold">{% trans "FREE DELIVERY" %}</span>
            {% endif %}
            <span class="text-xs text-dark/60">
              ({% trans "min subtotal" %} € {{ promo.min_subtotal|floatformat:2 }})
            </span>
          </div>
        {% endif %}
      </div>

      <a href="{% url 'restaurant:delivery_location' %}"
         class="text-sm font-semibold text-dark/70 hover:text-dark underline underline-offset-4">
        {% trans "Change location →" %}
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- LEFT: Categories -->
      <aside class="lg:col-span-3">
        <div class="frame p-4 bg-white/35 sticky top-24">
          <div class="brand-serif text-lg font-semibold mb-3">{% trans "Categories" %}</div>
          <div class="space-y-1">
            {% for c in categories %}
              <a href="#cat-{{ c.slug }}"
                 class="block px-3 py-2 rounded-sm text-sm font-semibold text-dark/75 hover:text-dark hover:bg-white/50">
                {{ c.name }}
              </a>
            {% endfor %}
          </div>

          <div class="mt-5 p-3 rounded-sm bg-white/40 border border-dark/10 text-xs text-dark/70">
            {% trans "Tip: Click an item to preview, then add to cart." %}
          </div>
        </div>
      </aside>

      <!-- CENTER: Items -->
      <main class="lg:col-span-6">
        <div class="space-y-10">
          {% for c in categories %}
            <div id="cat-{{ c.slug }}">
              <div class="brand-serif text-xl font-semibold mb-3">{{ c.name }}</div>

              <div class="space-y-3">
                {% for mi in items %}
                  {% if mi.category_id == c.id %}
                    <div class="frame p-4 bg-white/40 flex items-start justify-between gap-4">

                      <!-- Preview click -->
                      <div class="flex-1 min-w-0 flex items-start gap-4">

                        <!-- Image (premium thumb) -->
                        <div class="shrink-0 w-16 h-16 rounded-sm overflow-hidden border border-dark/10 bg-white/60">
                          {% if mi.image %}
                            <img src="{{ mi.image.url }}" alt="{{ mi.name }}" class="w-full h-full object-cover">
                          {% else %}
                            <div class="w-full h-full flex items-center justify-center text-[11px] text-dark/50">
                              {% trans "No image" %}
                            </div>
                          {% endif %}
                        </div>

                        <!-- Text / Preview -->
                        <div class="min-w-0 flex-1">
                          <button type="button"
                                  class="text-left w-full"
                                  data-preview-url="{% url 'restaurant:menu_item_detail' mi.id %}?ctx=delivery">
                            <div class="brand-serif text-base font-semibold hover:underline underline-offset-4 truncate">
                              {{ mi.name }}
                            </div>
                          </button>

                          {% if mi.description %}
                            <div class="text-sm text-dark/65 mt-1">
                              {{ mi.description|truncatechars:120 }}
                            </div>
                          {% endif %}

                          <div class="mt-2 flex items-center gap-2">
                            {% if mi.status == "sold_out" %}
                              <span class="inline-flex text-xs font-semibold px-2 py-1 rounded-sm bg-dark text-beige">
                                {% trans "Sold out" %}
                              </span>
                            {% else %}
                              <span class="inline-flex text-[11px] font-semibold px-2 py-1 rounded-sm bg-white/60 border border-dark/10 text-dark/70">
                                {% trans "Available" %}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      </div>

                      <!-- Add/Qty -->
                      <div class="shrink-0 text-right">
                        <div class="text-sm font-semibold">€ {{ mi.price|floatformat:2 }}</div>

                        <div class="mt-2 flex items-center justify-end gap-2">
                          <div class="hidden items-center gap-2" data-qty-wrap="{{ mi.id }}">
                            <button type="button"
                                    class="px-3 py-2 rounded-sm bg-white/70 border border-dark/10 hover:bg-white font-semibold"
                                    data-minus="{{ mi.id }}">−</button>

                            <div class="w-10 text-center font-semibold text-dark" data-qty="{{ mi.id }}">1</div>

                            <button type="button"
                                    class="px-3 py-2 rounded-sm bg-white/70 border border-dark/10 hover:bg-white font-semibold"
                                    data-plus="{{ mi.id }}">+</button>
                          </div>

                          <button type="button"
                                  class="btn-gold px-4 py-2 rounded-sm font-semibold text-dark text-sm
                                         {% if mi.status == 'sold_out' %}opacity-40 cursor-not-allowed{% endif %}"
                                  data-add="{{ mi.id }}"
                                  {% if mi.status == "sold_out" %}disabled{% endif %}>
                            {% trans "Add →" %}
                          </button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </main>

      <!-- RIGHT: Desktop Cart -->
      <aside class="lg:col-span-3 hidden lg:block">
        <div class="frame p-5 bg-[#3b231d] text-beige sticky top-24">
          <div class="brand-serif text-xl font-semibold text-white mb-3">{% trans "Your Cart" %}</div>

          <div id="cartItemsDesktop" class="space-y-2"></div>

          <div class="h-px bg-white/10 my-4"></div>

          <!-- ✅ Coupon block (Desktop) -->
          <div class="p-4 rounded-sm bg-black/20 border border-white/10">
            <div class="text-xs uppercase tracking-wider text-beige/70 mb-2">{% trans "Coupon" %}</div>

            <div id="couponErrorDesktop" class="hidden mb-2 text-[11px] text-red-200"></div>

            <div id="couponAppliedDesktop" class="{% if not coupon_code %}hidden{% endif %}">
              <div class="flex items-center justify-between gap-3">
                <div class="text-sm">
                  {% trans "Applied:" %} <span class="font-semibold text-white" id="couponCodeDesktop">{{ coupon_code }}</span>
                </div>
                <button type="button"
                        class="text-xs font-semibold text-white/80 hover:text-white underline underline-offset-4"
                        id="couponRemoveDesktop">
                  {% trans "Remove" %}
                </button>
              </div>
              <div class="mt-2 text-[11px] text-beige/70">{% trans "Discount is included in totals." %}</div>
            </div>

            <form id="couponFormDesktop" class="flex gap-2 {% if coupon_code %}hidden{% endif %}">
              {% csrf_token %}
              <input type="text"
                     name="coupon_code"
                     id="couponInputDesktop"
                     placeholder="{% trans "Enter code" %}"
                     autocomplete="off"
                     class="w-full px-3 py-2 rounded-sm bg-white/90 text-dark border border-dark/10 outline-none focus:border-gold/60">
              <button type="submit"
                      class="btn-gold px-4 py-2 rounded-sm font-semibold text-dark"
                      id="couponApplyDesktop">
                {% trans "Apply" %}
              </button>
            </form>

            <div class="mt-2 text-[11px] text-beige/70 {% if coupon_code %}hidden{% endif %}" id="couponHintDesktop">
              {% trans "Example:" %} SINET10
            </div>
          </div>

          <div class="h-px bg-white/10 my-4"></div>

          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <div class="text-beige/75">{% trans "Subtotal" %}</div>
              <div class="font-semibold text-white" id="cartSubtotalDesktop">€ 0.00</div>
            </div>

            <!-- ✅ Discount line (Desktop) -->
            <div id="couponRowDesktop" class="hidden flex justify-between">
              <div class="text-beige/75">{% trans "Coupon discount" %}</div>
              <div class="font-semibold text-white" id="couponDiscountDesktop">− € 0.00</div>
            </div>

            <div class="flex justify-between items-start gap-2">
              <div class="text-beige/75">
                {% trans "Delivery fee" %}
                <div id="promoLineDesktop" class="hidden text-[11px] text-beige/70 mt-1"></div>
              </div>
              <div class="font-semibold text-white text-right">
                <span id="cartFeeDesktop">€ 0.00</span>
              </div>
            </div>

            <div class="flex justify-between">
              <div class="text-beige/75">{% trans "Estimated total" %}</div>
              <div class="font-semibold text-white text-lg" id="cartTotalDesktop">€ 0.00</div>
            </div>
          </div>

          <button type="button"
                  class="mt-5 w-full btn-gold px-6 py-3 rounded-sm font-semibold text-dark disabled:opacity-50 disabled:cursor-not-allowed"
                  id="checkoutDesktop"
                  disabled>
            {% trans "Checkout → (Next)" %}
          </button>

          <div class="mt-2 text-[11px] text-beige/70">
            {% trans "Next: add your details (name + phone + instructions). Pay on delivery." %}
          </div>

          <button type="button"
                  class="mt-4 w-full text-xs font-semibold text-beige/80 hover:text-white underline underline-offset-4"
                  id="clearCartDesktop">
            {% trans "Clear cart" %}
          </button>
        </div>
      </aside>

    </div>
  </div>
</section>

<!-- Mobile Bottom Bar -->
<div class="lg:hidden fixed bottom-0 left-0 right-0 z-40">
  <div class="px-4 pb-4">
    <div class="frame bg-[#3b231d] text-beige p-3 rounded-sm shadow-lg border border-white/10 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-xs text-beige/75">{% trans "Cart" %}</div>
        <div class="font-semibold text-white truncate">
          <span id="mobileCount">0</span> {% trans "items" %} • <span id="mobileTotal">€ 0.00</span>
        </div>
      </div>
      <button id="openCart"
              class="btn-gold px-4 py-2 rounded-sm font-semibold text-dark shrink-0">
        {% trans "View cart →" %}
      </button>
    </div>
  </div>
</div>

<!-- Mobile Drawer -->
<div id="cartDrawer" class="hidden fixed inset-0 z-50">
  <div id="drawerBackdrop" class="absolute inset-0 bg-black/60"></div>

  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-beige shadow-xl flex flex-col">
    <div class="px-5 py-4 border-b border-dark/10 flex items-center justify-between">
      <div class="brand-serif text-lg font-semibold">{% trans "Your Cart" %}</div>
      <button id="closeCart" class="text-2xl leading-none text-dark/70 hover:text-dark">&times;</button>
    </div>

    <div class="p-5 overflow-auto flex-1">
      <div id="cartItemsMobile" class="space-y-2"></div>

      <div class="h-px bg-dark/10 my-4"></div>

      <!-- ✅ Coupon block (Mobile) -->
      <div class="p-4 rounded-sm bg-white/70 border border-dark/10">
        <div class="text-xs uppercase tracking-wider text-dark/60 mb-2">{% trans "Coupon" %}</div>

        <div id="couponErrorMobile" class="hidden mb-2 text-[11px] text-red-700"></div>

        <div id="couponAppliedMobile" class="{% if not coupon_code %}hidden{% endif %}">
          <div class="flex items-center justify-between gap-3">
            <div class="text-sm">
              {% trans "Applied:" %} <span class="font-semibold text-dark" id="couponCodeMobile">{{ coupon_code }}</span>
            </div>
            <button type="button"
                    class="text-xs font-semibold text-dark/70 hover:text-dark underline underline-offset-4"
                    id="couponRemoveMobile">
              {% trans "Remove" %}
            </button>
          </div>
          <div class="mt-2 text-[11px] text-dark/60">{% trans "Discount is included in totals." %}</div>
        </div>

        <form id="couponFormMobile" class="flex gap-2 {% if coupon_code %}hidden{% endif %}">
          {% csrf_token %}
          <input type="text"
                 name="coupon_code"
                 id="couponInputMobile"
                 placeholder="{% trans "Enter code" %}"
                 autocomplete="off"
                 class="w-full px-3 py-2 rounded-sm bg-white/90 text-dark border border-dark/15 outline-none focus:border-gold/60">
          <button type="submit"
                  class="btn-gold px-4 py-2 rounded-sm font-semibold text-dark"
                  id="couponApplyMobile">
            {% trans "Apply" %}
          </button>
        </form>

        <div class="mt-2 text-[11px] text-dark/60 {% if coupon_code %}hidden{% endif %}" id="couponHintMobile">
          {% trans "Example:" %} SINET10
        </div>
      </div>

      <div class="h-px bg-dark/10 my-4"></div>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <div class="text-dark/60">{% trans "Subtotal" %}</div>
          <div class="font-semibold text-dark" id="cartSubtotalMobile">€ 0.00</div>
        </div>

        <!-- ✅ Discount line (Mobile) -->
        <div id="couponRowMobile" class="hidden flex justify-between">
          <div class="text-dark/60">{% trans "Coupon discount" %}</div>
          <div class="font-semibold text-dark" id="couponDiscountMobile">− € 0.00</div>
        </div>

        <div class="flex justify-between items-start gap-2">
          <div class="text-dark/60">
            {% trans "Delivery fee" %}
            <div id="promoLineMobile" class="hidden text-[11px] text-dark/60 mt-1"></div>
          </div>
          <div class="font-semibold text-dark text-right">
            <span id="cartFeeMobile">€ 0.00</span>
          </div>
        </div>

        <div class="flex justify-between">
          <div class="text-dark/60">{% trans "Estimated total" %}</div>
          <div class="font-semibold text-dark text-lg" id="cartTotalMobile">€ 0.00</div>
        </div>
      </div>

      <button type="button"
              class="mt-5 w-full btn-gold px-6 py-3 rounded-sm font-semibold text-dark disabled:opacity-50 disabled:cursor-not-allowed"
              id="checkoutMobile"
              disabled>
        {% trans "Checkout → (Next)" %}
      </button>

      <div class="mt-2 text-[11px] text-dark/60">
        {% trans "Next: add your details (name + phone + instructions). Pay on delivery." %}
      </div>

      <button type="button"
              class="mt-4 w-full text-xs font-semibold text-dark/70 hover:text-dark underline underline-offset-4"
              id="clearCartMobile">
        {% trans "Clear cart" %}
      </button>
    </div>
  </div>
</div>

<!-- Preview modal -->
<div id="itemModal" class="hidden fixed inset-0 z-50">
  <div id="itemModalBackdrop" class="absolute inset-0 bg-black/60"></div>
  <div class="relative max-w-3xl mx-auto mt-10 bg-beige rounded-sm overflow-hidden shadow-lg">
    <div class="flex items-center justify-between px-5 py-4 border-b border-dark/10">
      <div class="font-semibold">{% trans "Item Details" %}</div>
      <button id="itemModalClose" class="text-dark/70 hover:text-dark text-2xl leading-none">&times;</button>
    </div>
    <div id="itemModalBody">
      <div class="p-6 text-sm text-dark/70">{% trans "Loading..." %}</div>
    </div>
  </div>
</div>

<!-- ✅ JS i18n strings (so gettext can extract + JS can use translations) -->
<div class="hidden">
  <span id="i18n-coupon-error">{% trans "Coupon error" %}</span>
  <span id="i18n-enter-coupon">{% trans "Please enter a coupon code." %}</span>
  <span id="i18n-invalid-coupon">{% trans "Invalid or expired coupon." %}</span>
  <span id="i18n-remove-coupon-failed">{% trans "Could not remove coupon." %}</span>
  <span id="i18n-empty-cart">{% trans "Your cart is empty." %}</span>
</div>

<script>
(function () {
  // Desktop
  const cartItemsDesktop = document.getElementById("cartItemsDesktop");
  const cartSubtotalDesktop = document.getElementById("cartSubtotalDesktop");
  const cartFeeDesktop = document.getElementById("cartFeeDesktop");
  const cartTotalDesktop = document.getElementById("cartTotalDesktop");
  const checkoutDesktop = document.getElementById("checkoutDesktop");
  const clearCartDesktop = document.getElementById("clearCartDesktop");

  // Coupon UI (Desktop)
  const couponRowDesktop = document.getElementById("couponRowDesktop");
  const couponDiscountDesktop = document.getElementById("couponDiscountDesktop");

  // Mobile
  const cartItemsMobile = document.getElementById("cartItemsMobile");
  const cartSubtotalMobile = document.getElementById("cartSubtotalMobile");
  const cartFeeMobile = document.getElementById("cartFeeMobile");
  const cartTotalMobile = document.getElementById("cartTotalMobile");
  const checkoutMobile = document.getElementById("checkoutMobile");
  const clearCartMobile = document.getElementById("clearCartMobile");

  // Coupon UI (Mobile)
  const couponRowMobile = document.getElementById("couponRowMobile");
  const couponDiscountMobile = document.getElementById("couponDiscountMobile");

  const mobileCount = document.getElementById("mobileCount");
  const mobileTotal = document.getElementById("mobileTotal");

  // Coupon controls
  const couponFormDesktop = document.getElementById("couponFormDesktop");
  const couponInputDesktop = document.getElementById("couponInputDesktop");
  const couponAppliedDesktop = document.getElementById("couponAppliedDesktop");
  const couponCodeDesktop = document.getElementById("couponCodeDesktop");
  const couponRemoveDesktop = document.getElementById("couponRemoveDesktop");
  const couponErrorDesktop = document.getElementById("couponErrorDesktop");
  const couponHintDesktop = document.getElementById("couponHintDesktop");

  const couponFormMobile = document.getElementById("couponFormMobile");
  const couponInputMobile = document.getElementById("couponInputMobile");
  const couponAppliedMobile = document.getElementById("couponAppliedMobile");
  const couponCodeMobile = document.getElementById("couponCodeMobile");
  const couponRemoveMobile = document.getElementById("couponRemoveMobile");
  const couponErrorMobile = document.getElementById("couponErrorMobile");
  const couponHintMobile = document.getElementById("couponHintMobile");

  const I18N = {
    coupon_error: (document.getElementById("i18n-coupon-error") || {}).textContent || "Coupon error",
    enter_coupon: (document.getElementById("i18n-enter-coupon") || {}).textContent || "Please enter a coupon code.",
    invalid_coupon: (document.getElementById("i18n-invalid-coupon") || {}).textContent || "Invalid or expired coupon.",
    remove_failed: (document.getElementById("i18n-remove-coupon-failed") || {}).textContent || "Could not remove coupon.",
    empty_cart: (document.getElementById("i18n-empty-cart") || {}).textContent || "Your cart is empty."
  };

  function csrfToken() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  function money(n){ return "€ " + (parseFloat(n || 0)).toFixed(2); }

  function showCouponError(where, msg) {
    const el = where === "desktop" ? couponErrorDesktop : couponErrorMobile;
    if (!el) return;
    el.textContent = msg || I18N.coupon_error;
    el.classList.remove("hidden");
  }

  function clearCouponErrors() {
    if (couponErrorDesktop) couponErrorDesktop.classList.add("hidden");
    if (couponErrorMobile) couponErrorMobile.classList.add("hidden");
  }

  function setCouponUIFromCart(cart) {
    const c = (cart && cart.coupon) ? cart.coupon : { active: false };
    const active = !!c.active;

    // Desktop
    if (couponAppliedDesktop && couponFormDesktop && couponHintDesktop && couponCodeDesktop) {
      if (active) {
        couponAppliedDesktop.classList.remove("hidden");
        couponFormDesktop.classList.add("hidden");
        couponHintDesktop.classList.add("hidden");
        couponCodeDesktop.textContent = c.code || "";
      } else {
        couponAppliedDesktop.classList.add("hidden");
        couponFormDesktop.classList.remove("hidden");
        couponHintDesktop.classList.remove("hidden");
        couponCodeDesktop.textContent = "";
      }
    }

    // Mobile
    if (couponAppliedMobile && couponFormMobile && couponHintMobile && couponCodeMobile) {
      if (active) {
        couponAppliedMobile.classList.remove("hidden");
        couponFormMobile.classList.add("hidden");
        couponHintMobile.classList.add("hidden");
        couponCodeMobile.textContent = c.code || "";
      } else {
        couponAppliedMobile.classList.add("hidden");
        couponFormMobile.classList.remove("hidden");
        couponHintMobile.classList.remove("hidden");
        couponCodeMobile.textContent = "";
      }
    }
  }

  async function apiGet(url) {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    return res.json();
  }

  async function apiPost(url, payload) {
    const fd = new FormData();
    Object.keys(payload || {}).forEach(k => fd.append(k, payload[k]));
    const res = await fetch(url, {
      method:"POST",
      headers: {
        "X-CSRFToken": csrfToken(),
        "X-Requested-With": "XMLHttpRequest"
      },
      body: fd
    });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, data };
  }

  function setItemQtyUI(id, qty) {
    const wrap = document.querySelector(`[data-qty-wrap="${id}"]`);
    const qtyEl = document.querySelector(`[data-qty="${id}"]`);
    const addBtn = document.querySelector(`[data-add="${id}"]`);
    if (!wrap || !qtyEl || !addBtn) return;

    if (qty > 0) {
      wrap.classList.remove("hidden");
      wrap.classList.add("flex");
      qtyEl.textContent = qty;
      addBtn.classList.add("hidden");
    } else {
      wrap.classList.add("hidden");
      wrap.classList.remove("flex");
      addBtn.classList.remove("hidden");
    }
  }

  // -------------------------
  // Item preview modal
  // -------------------------
  const itemModal = document.getElementById("itemModal");
  const itemModalBody = document.getElementById("itemModalBody");
  const itemModalClose = document.getElementById("itemModalClose");
  const itemModalBackdrop = document.getElementById("itemModalBackdrop");

  function openItemModal() {
    if (!itemModal) return;
    itemModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeItemModal() {
    if (!itemModal) return;
    itemModal.classList.add("hidden");
    if (itemModalBody) itemModalBody.innerHTML = `<div class="p-6 text-sm text-dark/70">{% trans "Loading..." %}</div>`;
    document.body.style.overflow = "";
  }

  async function loadPreview(url) {
    if (!url) return;

    if (!url.includes("ctx=")) {
      url += (url.includes("?") ? "&" : "?") + "ctx=delivery";
    }

    openItemModal();

    if (itemModalBody) itemModalBody.innerHTML = `<div class="p-6 text-sm text-dark/70">{% trans "Loading..." %}</div>`;

    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) throw new Error("failed");
      const html = await res.text();
      if (itemModalBody) itemModalBody.innerHTML = html;
    } catch {
      if (itemModalBody) itemModalBody.innerHTML = `<div class="p-6 text-sm text-dark/70">{% trans "Could not load item." %}</div>`;
    }
  }

  if (itemModalClose) itemModalClose.addEventListener("click", closeItemModal);
  if (itemModalBackdrop) itemModalBackdrop.addEventListener("click", closeItemModal);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeItemModal(); });

  // ✅ IMPORTANT: payload is { ok:true, cart:{ subtotal, delivery_fee, coupon_discount, coupon{...}, total, count, lines[] } }
  function renderFromSummaryPayload(payload) {
    if (!payload || !payload.ok || !payload.cart) return;

    const cart = payload.cart;
    const lines = cart.lines || [];
    const subtotal = parseFloat(cart.subtotal || 0);
    const fee = parseFloat(cart.delivery_fee || 0);
    const total = parseFloat(cart.total || (subtotal + fee));
    const count = parseInt(cart.count || 0, 10) || 0;

    const couponDiscount = parseFloat(cart.coupon_discount || 0);

    // Update top header fee
    const feeTop = document.getElementById("feeTop");
    if (feeTop) feeTop.textContent = money(fee);

    // Coupon discount line
    if (couponRowDesktop && couponDiscountDesktop) {
      if (couponDiscount > 0) {
        couponRowDesktop.classList.remove("hidden");
        couponDiscountDesktop.textContent = "− " + money(couponDiscount);
      } else {
        couponRowDesktop.classList.add("hidden");
      }
    }
    if (couponRowMobile && couponDiscountMobile) {
      if (couponDiscount > 0) {
        couponRowMobile.classList.remove("hidden");
        couponDiscountMobile.textContent = "− " + money(couponDiscount);
      } else {
        couponRowMobile.classList.add("hidden");
      }
    }

    // Reset all qty UI first
    document.querySelectorAll("[data-qty-wrap]").forEach(w => { w.classList.add("hidden"); w.classList.remove("flex"); });
    document.querySelectorAll("[data-add]").forEach(b => b.classList.remove("hidden"));

    if (cartItemsDesktop) cartItemsDesktop.innerHTML = "";
    if (cartItemsMobile) cartItemsMobile.innerHTML = "";

    if (!lines.length) {
      if (cartItemsDesktop) cartItemsDesktop.innerHTML = `<div class="text-sm text-beige/75">${I18N.empty_cart}</div>`;
      if (cartItemsMobile) cartItemsMobile.innerHTML = `<div class="text-sm text-dark/60">${I18N.empty_cart}</div>`;
      if (checkoutDesktop) checkoutDesktop.disabled = true;
      if (checkoutMobile) checkoutMobile.disabled = true;
    } else {
      lines.forEach(line => {
        setItemQtyUI(line.id, line.qty);

        if (cartItemsDesktop) {
          const row = document.createElement("div");
          row.className = "p-3 rounded-sm bg-black/20 border border-white/10";
          row.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-white truncate">${line.name}</div>
                <div class="text-xs text-beige/70">${money(line.unit_price)} × ${line.qty}</div>
              </div>
              <div class="text-white font-semibold">${money(line.line_total)}</div>
            </div>
          `;
          cartItemsDesktop.appendChild(row);
        }

        if (cartItemsMobile) {
          const row = document.createElement("div");
          row.className = "p-3 rounded-sm bg-white/70 border border-dark/10";
          row.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-dark truncate">${line.name}</div>
                <div class="text-xs text-dark/60">${money(line.unit_price)} × ${line.qty}</div>
              </div>
              <div class="text-dark font-semibold">${money(line.line_total)}</div>
            </div>
          `;
          cartItemsMobile.appendChild(row);
        }
      });

      if (checkoutDesktop) checkoutDesktop.disabled = false;
      if (checkoutMobile) checkoutMobile.disabled = false;
    }

    if (cartSubtotalDesktop) cartSubtotalDesktop.textContent = money(subtotal);
    if (cartFeeDesktop) cartFeeDesktop.textContent = money(fee);
    if (cartTotalDesktop) cartTotalDesktop.textContent = money(total);

    if (cartSubtotalMobile) cartSubtotalMobile.textContent = money(subtotal);
    if (cartFeeMobile) cartFeeMobile.textContent = money(fee);
    if (cartTotalMobile) cartTotalMobile.textContent = money(total);

    if (mobileCount) mobileCount.textContent = count;
    if (mobileTotal) mobileTotal.textContent = money(total);

    // Coupon UI from cart (single source of truth)
    setCouponUIFromCart(cart);
  }

  async function refreshSummary() {
    const payload = await apiGet("{% url 'restaurant:delivery_cart_summary' %}");
    renderFromSummaryPayload(payload);
    return payload;
  }

  async function addItem(id) {
    await apiPost("{% url 'restaurant:delivery_cart_add' %}", { item_id: id, qty: 1 });
    await refreshSummary();
  }

  async function setQty(id, qty) {
    await apiPost("{% url 'restaurant:delivery_cart_update' %}", { item_id: id, qty: qty });
    await refreshSummary();
  }

  async function clearCart() {
    const payload = await refreshSummary();
    const lines = (payload && payload.ok && payload.cart && payload.cart.lines) ? payload.cart.lines : [];
    for (const it of lines) {
      await setQty(it.id, 0);
    }
    await refreshSummary();
  }

  // -------------------------
  // Coupon apply/remove
  // -------------------------
  async function applyCoupon(code, where) {
    clearCouponErrors();
    const clean = (code || "").trim();
    if (!clean) {
      showCouponError(where, I18N.enter_coupon);
      return;
    }

    const { ok, data } = await apiPost("{% url 'restaurant:delivery_apply_coupon' %}", { coupon_code: clean });
    if (!ok || !data || !data.ok) {
      showCouponError(where, (data && data.error) ? data.error : I18N.invalid_coupon);
      return;
    }
    renderFromSummaryPayload({ ok: true, cart: data.cart });
  }

  async function removeCoupon() {
    clearCouponErrors();
    const { ok, data } = await apiPost("{% url 'restaurant:delivery_remove_coupon' %}", {});
    if (!ok || !data || !data.ok) {
      showCouponError("desktop", I18N.remove_failed);
      showCouponError("mobile", I18N.remove_failed);
      return;
    }
    renderFromSummaryPayload({ ok: true, cart: data.cart });
  }

  if (couponFormDesktop) {
    couponFormDesktop.addEventListener("submit", (e) => {
      e.preventDefault();
      applyCoupon(couponInputDesktop ? couponInputDesktop.value : "", "desktop");
    });
  }

  if (couponFormMobile) {
    couponFormMobile.addEventListener("submit", (e) => {
      e.preventDefault();
      applyCoupon(couponInputMobile ? couponInputMobile.value : "", "mobile");
    });
  }

  if (couponRemoveDesktop) couponRemoveDesktop.addEventListener("click", removeCoupon);
  if (couponRemoveMobile) couponRemoveMobile.addEventListener("click", removeCoupon);

  // -------------------------
  // Click handlers
  // -------------------------
  document.addEventListener("click", async (e) => {
    const previewBtn = e.target.closest("[data-preview-url]");
    if (previewBtn) {
      await loadPreview(previewBtn.dataset.previewUrl);
      return;
    }

    const addFromModalDelivery = e.target.closest("[data-add-delivery]");
    if (addFromModalDelivery) {
      const id = addFromModalDelivery.getAttribute("data-add-delivery");
      if (id) {
        await addItem(id);
        closeItemModal();
      }
      return;
    }

    const add = e.target.closest("[data-add]");
    if (add) { await addItem(add.dataset.add); return; }

    const plus = e.target.closest("[data-plus]");
    if (plus) {
      const id = plus.dataset.plus;
      const qtyEl = document.querySelector(`[data-qty="${id}"]`);
      const cur = parseInt(qtyEl ? qtyEl.textContent : "0", 10) || 0;
      await setQty(id, cur + 1);
      return;
    }

    const minus = e.target.closest("[data-minus]");
    if (minus) {
      const id = minus.dataset.minus;
      const qtyEl = document.querySelector(`[data-qty="${id}"]`);
      const cur = parseInt(qtyEl ? qtyEl.textContent : "0", 10) || 0;
      await setQty(id, cur - 1);
      return;
    }
  });

  if (clearCartDesktop) clearCartDesktop.addEventListener("click", clearCart);
  if (clearCartMobile) clearCartMobile.addEventListener("click", clearCart);

  if (checkoutDesktop) checkoutDesktop.addEventListener("click", () => {
    window.location.href = "{% url 'restaurant:delivery_checkout' %}";
  });
  if (checkoutMobile) checkoutMobile.addEventListener("click", () => {
    window.location.href = "{% url 'restaurant:delivery_checkout' %}";
  });

  // -------------------------
  // Mobile drawer open/close
  // -------------------------
  const openCartBtn = document.getElementById("openCart");
  const cartDrawer = document.getElementById("cartDrawer");
  const closeCartBtn = document.getElementById("closeCart");
  const drawerBackdrop = document.getElementById("drawerBackdrop");

  function openDrawer() {
    if (!cartDrawer) return;
    cartDrawer.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeDrawer() {
    if (!cartDrawer) return;
    cartDrawer.classList.add("hidden");
    document.body.style.overflow = "";
  }

  if (openCartBtn) openCartBtn.addEventListener("click", openDrawer);
  if (closeCartBtn) closeCartBtn.addEventListener("click", closeDrawer);
  if (drawerBackdrop) drawerBackdrop.addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDrawer(); });

  // init
  refreshSummary();
})();
</script>

{% endblock %}
