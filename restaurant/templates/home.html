{% extends "base.html" %}
{% load static i18n %}

{% block title %}Home – {{ settings.RESTAURANT_NAME }}{% endblock %}

{% block content %}

<!-- HERO -->
<section class="relative">
  <div class="relative h-[520px] md:h-[640px] overflow-hidden">
  
  {% for banner in hero_banners %}
    <div
      class="hero-slide absolute inset-0 bg-center bg-cover transition-opacity duration-1000 opacity-0"
      style="background-image:url('{{ banner.image.url }}');">
    </div>
  {% empty %}
    <div
      class="absolute inset-0 bg-center bg-cover"
      style="background-image:url('{% static 'images/hero_pizza.jpg' %}');">
    </div>
  {% endfor %}

    <div class="absolute inset-0 bg-black/35"></div>

    <div class="relative h-full flex items-start justify-center">
      <div class="pt-16 md:pt-20 text-center px-6">
        <div class="brand-script text-white text-5xl md:text-7xl leading-none drop-shadow-[0_10px_30px_rgba(0,0,0,.55)]">
          {{ settings.RESTAURANT_NAME }}
        </div>

        <div class="mt-2 flex items-center justify-center gap-4 text-white/90">
          <div class="hairline w-16 bg-white/60"></div>
          <div class="uppercase tracking-[0.35em] text-xs md:text-sm text-center">
            {% trans "Taste of Joensuu" %}<br>
            <span class="block mt-2 tracking-[0.25em] text-[10px] md:text-xs">
              {% trans "Since 2007" %}
            </span>
          </div>
          <div class="hairline w-16 bg-white/60"></div>
        </div>

        <div class="mt-7 grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 max-w-md sm:max-w-none mx-auto">
          <a href="{% url 'restaurant:reservation' %}"
             class="btn-gold w-full text-dark px-7 py-3 rounded-sm font-semibold text-center">
            {% trans "Make Reservation" %}
          </a>
         
          <a href="{% url 'restaurant:menu' %}"
             class="btn-gold w-full text-dark px-7 py-3 rounded-sm font-semibold text-center">
            {% trans "View Menu" %}
          </a>

          <a href="{% url 'restaurant:menu' %}"
             class="btn-gold text-dark px-7 py-3 rounded-sm font-semibold">
            {% trans "Order Online" %}
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- INFO STRIP -->
  <div class="paper-bg border-t border-lightbrown/30">
    <div class="max-w-6xl mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 py-6 text-center">

        <div class="flex items-center justify-center gap-3">
          <svg class="w-8 h-8 text-gold" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M20 4c-7 0-12 5-12 12 0 2.5 1 4.5 2.5 6 1.5-1.5 3.5-2.5 6-2.5 7 0 12-5 12-12 0-1-0.2-2-0.5-3.5C26.5 4.2 24 4 20 4Z" />
            <path d="M8 16c2-2 5-3 9-3" />
          </svg>
          <div class="text-left">
            <div class="brand-serif text-lg font-semibold">{% trans "Fresh Ingredients" %}</div>
            <div class="text-sm text-dark/70">{% trans "Locally sourced produce" %}</div>
          </div>
        </div>

        <div class="hidden md:flex items-center justify-center">
          <div class="h-10 w-px bg-lightbrown/35"></div>
        </div>

        <div class="flex items-center justify-center gap-3">
          <svg class="w-8 h-8 text-gold" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M7 10h10M7 14h10" />
            <path d="M3 9v6M21 9v6" />
          </svg>
          <div class="text-left">
            <div class="brand-serif text-lg font-semibold">{% trans "Handcrafted Dough" %}</div>
            <div class="text-sm text-dark/70">{% trans "Pizza dough made in-house" %}</div>
          </div>
        </div>

        <div class="hidden md:flex items-center justify-center">
          <div class="h-10 w-px bg-lightbrown/35"></div>
        </div>

        <div class="flex items-center justify-center gap-3">
          <svg class="w-8 h-8 text-gold" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="12" cy="12" r="9" />
            <path d="M12 7v6l4 2" />
          </svg>
          <div class="text-left">
            <div class="brand-serif text-lg font-semibold">
              {% blocktrans with hours=settings.RESTAURANT_OPENING_HOURS %}Open Daily {{ hours }}{% endblocktrans %}
            </div>
            <div class="text-sm text-dark/70">{% trans "Welcome every day." %}</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<!-- FAVORITES -->
<section class="paper-bg">
  <div class="max-w-6xl mx-auto px-6 py-10">

    <div class="text-center">
      <div class="flex items-center justify-center gap-4">
        <div class="hairline w-28"></div>
        <h2 class="brand-script text-4xl md:text-5xl text-dark">{% trans "Customer Favorites" %}</h2>
        <div class="hairline w-28"></div>
      </div>
      <div class="mt-2 text-xs uppercase tracking-[0.35em] text-dark/60">
        {% trans "Most Loved Dishes" %}
      </div>
    </div>

    <div class="mt-10 grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5">
      {% for item in popular_items|slice:":4" %}
        <div class="group" data-item-url="{% url 'restaurant:menu_item_detail' item.id %}" role="button" tabindex="0">
          <div class="relative h-full rounded-2xl border border-[#3e2723]/10 bg-white/80 overflow-hidden
                      shadow-[0_12px_30px_rgba(0,0,0,0.08)]
                      hover:shadow-[0_18px_45px_rgba(0,0,0,0.12)]
                      transition">

            <div class="pointer-events-none absolute -inset-8 opacity-0 group-hover:opacity-100 transition">
              <div class="absolute inset-0 bg-[#bfa76f]/15 blur-3xl"></div>
            </div>

            <div class="relative aspect-[4/3] overflow-hidden">
              {% if item.image %}
                <img src="{{ item.image.url }}"
                     alt="{{ item.name }}"
                     class="h-full w-full object-cover transition duration-500 group-hover:scale-[1.04]" />
              {% else %}
                <div class="h-full w-full bg-[#f5f0e6] flex items-center justify-center text-[#3e2723]/60 text-sm">
                  No image
                </div>
              {% endif %}

              <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/35 via-black/10 to-transparent"></div>

              <div class="absolute left-3 top-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-full
                          bg-white/15 text-white border border-white/20 backdrop-blur
                          text-[10px] font-semibold uppercase tracking-[0.22em]">
                Favorite
              </div>

              <div class="absolute right-2 top-2 sm:right-3 sm:top-3 px-2.5 py-1 rounded-full text-[11px] sm:text-xs font-semibold
                          bg-white/85 border border-[#3e2723]/10 text-[#3e2723]">
                € {{ item.price|floatformat:2 }}
              </div>
            </div>

            <div class="p-3 sm:p-4 flex flex-col">
              <div class="min-w-0">
                <div class="text-base font-semibold text-[#3e2723] truncate">
                  {{ item.name }}
                </div>

                <div class="mt-1 text-[11px] uppercase tracking-[0.25em] text-[#3e2723]/55 min-h-[14px]">
                  {% if item.category %}{{ item.category.name }}{% endif %}
                </div>

                <p class="mt-3 text-sm text-[#3e2723]/70 leading-relaxed line-clamp-2 min-h-[40px]">
                  {{ item.description|default:"" }}
                </p>
              </div>

              <div class="mt-4 pt-4 border-t border-[#3e2723]/10 flex items-center justify-between gap-3">
                <button type="button"
                        class="text-xs font-semibold underline underline-offset-4 text-[#3e2723]/70 hover:text-[#3e2723]"
                        data-preview="1">
                  Preview
                </button>

                <button type="button"
                        data-order-now="{{ item.id }}"
                        class="rounded-full px-3 py-2 text-xs sm:text-sm font-semibold
                               bg-[#bfa76f] text-[#2a1a14] border border-[#3e2723]/10
                               shadow-[0_10px_20px_rgba(0,0,0,0.10)]
                               hover:brightness-95 active:scale-[0.99] transition">
                  Order Now →
                </button>
              </div>
            </div>

          </div>
        </div>
      {% empty %}
        <div class="text-center text-sm text-[#3e2723]/60 col-span-full">
          {% blocktrans %}No customer favorites yet. Add tag <b>popular</b> to menu items in the admin panel.{% endblocktrans %}
        </div>
      {% endfor %}
    </div>

    <div class="mt-14 text-center">
      <h3 class="brand-script text-4xl text-dark">{% trans "Explore Our Menu" %}</h3>
      <div class="mt-6 flex flex-wrap justify-center gap-3">
        {% for category in categories|slice:":5" %}
          <a
            href="{{ category.get_absolute_url }}"
            class="px-6 py-2 rounded-full border border-lightbrown/45 bg-white/60 hover:bg-[#3b231d] hover:text-beige transition">
            {{ category.name }}
          </a>
        {% endfor %}
      </div>
    </div>

    <div class="mt-10 relative">
      <div class="absolute -inset-4 bg-dark/10 blur-2xl rounded-2xl"></div>
      <div class="absolute -inset-2 bg-gold/10 blur-xl rounded-2xl"></div>

      <div class="relative frame overflow-hidden bg-white/30">
        <div class="grid grid-cols-1 lg:grid-cols-3 items-stretch">

          <div class="lg:col-span-2 relative bg-white/20">
            <div class="relative h-full min-h-[380px]">
              <div class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/25 via-transparent to-transparent z-10"></div>

              <div class="absolute left-5 top-5 z-20 bg-white/75 backdrop-blur px-4 py-2 rounded-sm border border-dark/10">
                <div class="text-xs uppercase tracking-[0.25em] text-dark/70">{% trans "Find Us" %}</div>
                <div class="brand-serif text-sm font-semibold text-dark">{{ settings.RESTAURANT_NAME }}</div>
              </div>

              <iframe
                title="{{ settings.RESTAURANT_NAME }} Location"
                class="absolute inset-0 w-full h-full"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                allowfullscreen
                src="https://www.google.com/maps?q=Kauppakatu%2028,%2080100%20Joensuu&z=17&output=embed">
              </iframe>
            </div>
          </div>

          <div class="p-6 md:p-7 flex flex-col justify-center bg-paper h-full">
            <div class="brand-serif text-2xl font-semibold mb-2">
              {% trans "Visit Ravintola Sinet" %}
            </div>

            <div class="text-sm text-dark/70 leading-relaxed mb-6">
              <div class="font-semibold text-dark/80 mb-1">{% trans "Address" %}</div>
              <div>{{ settings.RESTAURANT_ADDRESS }}</div>

              <div class="mt-6 font-semibold text-dark/80 mb-1">{% trans "Phone" %}</div>
              <a href="tel:+358504557367" class="text-dark hover:text-gold underline underline-offset-4">
                +358504557367
              </a>
            </div>

            <div class="mt-6">
              <a
                href="https://maps.app.goo.gl/GFEB3mypqX71faYQA"
                target="_blank"
                rel="noopener noreferrer"
                class="btn-gold px-6 py-3 rounded-sm font-semibold inline-block">
                {% trans "Get Directions →" %}
              </a>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>

<!-- Toast -->
<div id="toastAdded"
     class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[60]
            px-4 py-3 rounded-sm shadow-lg border border-dark/10
            bg-white/90 text-dark text-sm font-semibold">
  Added to table.
</div>

<!-- Item Modal -->
<div id="itemModal" class="hidden fixed inset-0 z-[90]">
  <div id="itemModalBackdrop" class="absolute inset-0 bg-black/60"></div>

  <div class="relative h-full w-full flex items-start sm:items-center justify-center p-3 sm:p-6">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-[#3e2723]/10 overflow-hidden
                max-h-[92vh] sm:max-h-[85vh] flex flex-col">

      <div class="flex items-center justify-between px-5 py-4 border-b border-[#3e2723]/10 bg-[#f5f0e6]/60">
        <div class="text-sm font-semibold text-[#3e2723]">Item details</div>

        <button id="itemModalClose"
                class="h-9 w-9 rounded-full border border-[#3e2723]/15 bg-white hover:bg-[#f5f0e6]
                       flex items-center justify-center text-xl leading-none text-[#3e2723] active:scale-95 transition">
          &times;
        </button>
      </div>

      <div id="itemModalBody"
           class="flex-1 overflow-y-auto p-5 sm:p-6 text-[#3e2723]/70">
        Loading...
      </div>
    </div>
  </div>
</div>

<!-- ✅ HOME: MENU-LIKE short checkout bar ONLY (no drawer / no back part) -->
<div id="homeCartBar" class="lg:hidden fixed bottom-0 left-0 right-0 z-[70] hidden">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 pb-3">
    <button type="button"
            id="homeCartBarBtn"
            class="w-full rounded-2xl bg-[#3e2723] text-white shadow-2xl border border-white/10
                   flex items-center justify-between gap-4 px-4 sm:px-5 py-3 active:scale-[0.99] transition">
      <div class="flex items-center gap-3 min-w-0">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/10 text-white font-bold"
              id="homeCartCount">0</span>
        <div class="min-w-0">
          <div class="text-sm font-semibold truncate">Your cart</div>
          <div class="text-xs text-white/70 truncate">Tap to review &amp; checkout</div>
        </div>
      </div>

      <div class="text-right">
        <div class="text-sm font-semibold" id="homeCartTotal">€ 0.00</div>
        <div class="text-xs text-white/70">Total</div>
      </div>
    </button>
  </div>
</div>

<!-- ✅ HOME: Drawer (menu-like) -->
<div id="homeCartDrawer" class="fixed inset-0 z-[80] hidden">
  <div id="homeCartDrawerBackdrop" class="absolute inset-0 bg-black/60"></div>

  <div id="homeCartDrawerPanel"
       class="absolute right-0 top-0 h-full w-full max-w-sm bg-white shadow-2xl
              transform translate-x-full transition duration-300">

    <div class="h-full flex flex-col">
      <div class="p-5 border-b border-[#3e2723]/10 flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-[0.35em] text-[#3e2723]/60">Cart</div>
          <h3 class="text-lg font-semibold text-[#3e2723]">
            Your Order • <span id="homeDrawerCountLabel">0</span>
          </h3>
        </div>

        <button id="homeCartDrawerClose"
                class="h-10 w-10 rounded-full border border-[#3e2723]/15 bg-white hover:bg-[#f5f0e6]
                       flex items-center justify-center text-2xl leading-none text-[#3e2723] active:scale-95 transition">
          &times;
        </button>
      </div>

      <div id="homeDrawerItems" class="flex-1 overflow-y-auto p-5 space-y-4"></div>

      <div class="border-t border-[#3e2723]/10 p-5 space-y-4 bg-white">
        <div class="flex items-center justify-between text-sm text-[#3e2723]/70">
          <span>Subtotal</span>
          <span id="homeDrawerSubtotal">€ 0.00</span>
        </div>

        <div class="flex items-center justify-between text-sm text-[#3e2723]/70">
          <span>Delivery</span>
          <span id="homeDrawerDelivery">€ 0.00</span>
        </div>

        <div class="flex justify-between font-semibold text-lg text-[#3e2723]">
          <span>Total</span>
          <span id="homeDrawerTotal">€ 0.00</span>
        </div>

        <a href="{% url 'restaurant:menu' %}?open_cart=1"
           class="block w-full text-center bg-[#3e2723] text-white py-3 rounded-xl font-semibold
                  hover:opacity-95 active:scale-[0.99] transition">
          Continue in Menu →
        </a>

    </div>
  </div>
</div>

<!-- spacer so bar never covers content -->
<div class="lg:hidden h-24"></div>

<script>
(function () {
  // Modal
  const modal = document.getElementById("itemModal");
  const body = document.getElementById("itemModalBody");
  const closeBtn = document.getElementById("itemModalClose");
  const backdrop = document.getElementById("itemModalBackdrop");

  function openModal() {
    if (!modal) return;
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.add("hidden");
    if (body) body.innerHTML = "Loading...";
    document.body.style.overflow = "";
  }

  async function loadItem(url) {
    if (!url) return;
    openModal();
    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) throw new Error("Failed");
      if (body) body.innerHTML = await res.text();
    } catch {
      if (body) body.innerHTML = '<div class="p-6 text-sm text-dark/70">Could not load item.</div>';
    }
  }

  if (closeBtn) closeBtn.addEventListener("click", closeModal);
  if (backdrop) backdrop.addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  // Toast
  function showToast(text) {
    const toast = document.getElementById("toastAdded");
    if (!toast) return;
    toast.textContent = text || "Added to table.";
    toast.classList.remove("hidden");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => toast.classList.add("hidden"), 2000);
  }

  // Cookies
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }

  // Badge in header (optional)
  function findCartBadgeEl() {
    return (
      document.querySelector("#cartBadge") ||
      document.querySelector("[data-cart-badge]") ||
      document.querySelector("#cartCount") ||
      document.querySelector(".cart-badge")
    );
  }

  function setCartBadge(count) {
    const el = findCartBadgeEl();
    if (!el) return;
    const n = parseInt(count || 0, 10) || 0;
    el.textContent = String(n);
    if (n > 0) el.classList.remove("hidden");
    else el.classList.add("hidden");
  }

  // HOME checkout bar
  const barWrap = document.getElementById("homeCartBar");
  const barBtn = document.getElementById("homeCartBarBtn");
  const barCount = document.getElementById("homeCartCount");
  const barTotal = document.getElementById("homeCartTotal");

  const MENU_URL = "{% url 'restaurant:menu' %}";

  function money(n) {
    return "€ " + (Number(n) || 0).toFixed(2);
  }

const drawerItems = document.getElementById("homeDrawerItems");
const drawerCountLabel = document.getElementById("homeDrawerCountLabel");
const drawerSubtotal = document.getElementById("homeDrawerSubtotal");
const drawerDelivery = document.getElementById("homeDrawerDelivery");
const drawerTotal = document.getElementById("homeDrawerTotal");

function renderHomeBar(cart) {
  const count = parseInt(cart?.count || 0, 10) || 0;
  const total = Number(cart?.total || 0) || 0;

  setCartBadge(count);

  // bar
  if (barCount) barCount.textContent = String(count);
  if (barTotal) barTotal.textContent = money(total);
  if (barWrap) barWrap.classList.toggle("hidden", count <= 0);

  // drawer header + totals
  if (drawerCountLabel) drawerCountLabel.textContent = String(count);
  if (drawerSubtotal) drawerSubtotal.textContent = money(cart?.subtotal || 0);
  if (drawerDelivery) drawerDelivery.textContent = money(cart?.delivery_fee || 0);
  if (drawerTotal) drawerTotal.textContent = money(cart?.total || 0);

  // drawer lines with qty controls
  const lines = Array.isArray(cart?.lines) ? cart.lines : [];
  if (drawerItems) {
    if (!lines.length) {
      drawerItems.innerHTML =
        `<div class="text-sm text-[#3e2723]/60 text-center py-8">Your cart is empty.</div>`;
    } else {
      drawerItems.innerHTML = lines.map(l => {
        const id = String(l.id);
        const name = (l.name || "Item").toString();
        const qty = parseInt(l.qty || 0, 10) || 0;
        const lineTotal = money(l.line_total || 0);

        return `
          <div class="rounded-2xl border border-[#3e2723]/10 bg-[#f5f0e6]/60 p-4"
               data-home-row data-item-id="${id}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-[#3e2723] truncate">${name}</div>

                <div class="mt-3 flex items-center gap-2">
                  <button type="button"
                          class="h-8 w-8 rounded-lg bg-white border border-[#3e2723]/10 text-[#3e2723] font-bold active:scale-95 transition"
                          data-home-qty="dec">−</button>

                  <span class="min-w-[22px] text-center text-sm font-semibold text-[#3e2723]"
                        data-home-qty-value>${qty}</span>

                  <button type="button"
                          class="h-8 w-8 rounded-lg bg-white border border-[#3e2723]/10 text-[#3e2723] font-bold active:scale-95 transition"
                          data-home-qty="inc">+</button>

                  <button type="button"
                          class="ml-2 text-xs font-semibold text-red-600 hover:underline underline-offset-4"
                          data-home-qty="remove">Remove</button>
                </div>
              </div>

              <div class="shrink-0 text-right">
                <div class="text-[11px] uppercase tracking-wider text-[#3e2723]/50">TOTAL</div>
                <div class="font-semibold text-[#3e2723]">${lineTotal}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }
  }

  // keep snapshot for qty logic
  window.__HOME_LAST_CART__ = cart;
}

  async function refreshHomeBar() {
    try {
      const res = await fetch("{% url 'restaurant:delivery_cart_summary' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.ok && data.cart) renderHomeBar(data.cart);
    } catch {
      // ignore
    }
  }

  const URL_CART_UPDATE = "{% url 'restaurant:delivery_cart_update' %}";

async function updateQty(itemId, qty) {
  const csrf = getCookie("csrftoken");

  const form = new URLSearchParams();
  form.append("item_id", String(itemId));
  form.append("qty", String(qty));

  const res = await fetch(URL_CART_UPDATE, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
      "X-CSRFToken": csrf,
      "X-Requested-With": "XMLHttpRequest",
    },
    body: form.toString(),
  });

  if (!res.ok) throw new Error("Failed to update qty");
  const data = await res.json();

  if (data && data.ok && data.cart) renderHomeBar(data.cart);
  return data;
}

  async function addToDeliveryCart(itemId, qty) {
    const csrf = getCookie("csrftoken");
    const form = new URLSearchParams();
    form.append("item_id", String(itemId));
    form.append("qty", String(qty || 1));

    const res = await fetch("{% url 'restaurant:delivery_cart_add' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: form.toString(),
    });

    if (!res.ok) throw new Error("Failed to add to cart");
    const data = await res.json();
    if (data && data.ok && data.cart) renderHomeBar(data.cart);
    return data;
  }

// ===== Drawer refs + open/close =====
const drawerRoot = document.getElementById("homeCartDrawer");
const drawerPanel = document.getElementById("homeCartDrawerPanel");
const drawerBackdrop = document.getElementById("homeCartDrawerBackdrop");
const drawerClose = document.getElementById("homeCartDrawerClose");

function openDrawer() {
  if (!drawerRoot || !drawerPanel) return;
  drawerRoot.classList.remove("hidden");
  requestAnimationFrame(() => drawerPanel.classList.remove("translate-x-full"));
  document.body.style.overflow = "hidden";
}

function closeDrawer() {
  if (!drawerRoot || !drawerPanel) return;
  drawerPanel.classList.add("translate-x-full");
  setTimeout(() => {
    drawerRoot.classList.add("hidden");
    document.body.style.overflow = "";
  }, 220);
}

if (drawerBackdrop) drawerBackdrop.addEventListener("click", closeDrawer);
if (drawerClose) drawerClose.addEventListener("click", closeDrawer);

// Bar click => open drawer
if (barBtn) barBtn.addEventListener("click", openDrawer);
  // Delegated click handler
  document.addEventListener("click", async (e) => {
      // ===== Drawer qty controls (+ / - / remove) =====
  const qtyBtn = e.target.closest("[data-home-qty]");
  if (qtyBtn) {
    const row = qtyBtn.closest("[data-home-row]");
    if (!row) return;

    const id = row.getAttribute("data-item-id");
    const action = qtyBtn.getAttribute("data-home-qty");

    const cart = window.__HOME_LAST_CART__;
    const lines = cart && Array.isArray(cart.lines) ? cart.lines : [];
    const line = lines.find(x => String(x.id) === String(id));
    const current = line ? (parseInt(line.qty || 0, 10) || 0) : 0;

    if (action === "inc") {
      await updateQty(id, current + 1);
      return;
    }
    if (action === "dec") {
      await updateQty(id, Math.max(0, current - 1));
      return;
    }
    if (action === "remove") {
      await updateQty(id, 0);
      return;
    }
    return;
  }
    // ✅ Preview button: do NOT also trigger card click
    const previewBtn = e.target.closest("[data-preview]");
    if (previewBtn) {
      e.preventDefault();
      e.stopPropagation();
      const card = previewBtn.closest("[data-item-url]");
      const url = card ? card.getAttribute("data-item-url") : "";
      if (url) loadItem(url);
      return;
    }

    // ✅ ORDER NOW: add + go to menu cart (NOT delivery_location)
    const orderNow = e.target.closest("[data-order-now]");
    if (orderNow) {
      e.preventDefault();
      e.stopPropagation();

      const id = orderNow.getAttribute("data-order-now");
      if (!id) return;

      try {
        orderNow.disabled = true;
        await addToDeliveryCart(id, 1);
        window.location.href = MENU_URL + "?open_cart=1";
      } catch {
        showToast("Could not add to cart.");
        orderNow.disabled = false;
      }
      return;
    }

    // Add Dine-in from modal (reservation preorder)
    const dineBtn = e.target.closest("[data-add-dinein]");
    if (dineBtn) {
      const id = dineBtn.getAttribute("data-add-dinein");
      const name = dineBtn.getAttribute("data-name") || "Item";
      const price = dineBtn.getAttribute("data-price") || "0";

      const key = "reservation_preorder";
      const raw = localStorage.getItem(key);
      const cart = raw ? JSON.parse(raw) : {};
      const sid = String(id);
      if (!cart[sid]) cart[sid] = { name, price: String(price), qty: 0 };
      cart[sid].qty = (parseInt(cart[sid].qty || 0, 10) || 0) + 1;
      localStorage.setItem(key, JSON.stringify(cart));

      showToast(`Added: ${name}`);
      closeModal();
      return;
    }

    // Add Delivery from modal: add + keep modal (or close - your choice)
    const delBtn = e.target.closest("[data-add-delivery]");
    if (delBtn) {
      try {
        delBtn.disabled = true;
        const id = delBtn.getAttribute("data-add-delivery");
        await addToDeliveryCart(id, 1);
        showToast("Added to cart ✅");
        closeModal();
      } catch {
        showToast("Could not add to cart.");
      } finally {
        delBtn.disabled = false;
      }
      return;
    }

    // Open modal when clicking a card
    const card = e.target.closest("[data-item-url]");
    if (card) {
      const url = card.getAttribute("data-item-url");
      if (url) loadItem(url);
      return;
    }
  });

  // Keyboard open for focused card
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Enter" && e.key !== " ") return;
    const card = document.activeElement && document.activeElement.closest
      ? document.activeElement.closest("[data-item-url]")
      : null;
    if (!card) return;
    e.preventDefault();
    const url = card.getAttribute("data-item-url");
    if (url) loadItem(url);
  });

  // HERO slideshow
  const slides = document.querySelectorAll(".hero-slide");
  if (slides.length) {
    let index = 0;
    slides[0].classList.remove("opacity-0");
    setInterval(() => {
      slides[index].classList.add("opacity-0");
      index = (index + 1) % slides.length;
      slides[index].classList.remove("opacity-0");
    }, 5000);
  }

  // init bar
  refreshHomeBar();
})();
</script>

{% endblock %}